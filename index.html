<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI äº”å­æ£‹å¯¹æˆ˜ v1</title> {/* ç‰ˆæœ¬ä¿®æ”¹ */}
    <style>
        /* --- Global Styles & Resets --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align top */
            min-height: 100vh;
            background-color: #f0f2f5;
            color: #333;
            padding: 15px;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* --- Layout Containers --- */
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px; /* Limit max width */
        }

        .main-content {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            justify-content: center;
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .board-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* ä¸ºæ ‡ç­¾æ·»åŠ  */
            --label-size: 25px; /* æ ‡ç­¾åŒºåŸŸçš„å¤§å° */
            --board-size: 15; /* æ£‹ç›˜å¤§å°çš„ CSS å˜é‡ */
            /* å“åº”å¼å•å…ƒæ ¼å¤§å° - åº”å…è®¸åœ¨å¤§å¤šæ•°å±å¹•ä¸Šå®Œæ•´æ˜¾ç¤ºæ£‹ç›˜ */
            --cell-size: clamp(20px, 4.5vmin, 35px);
            --board-dimension: calc(var(--board-size) * var(--cell-size));
            /* Padding provides space for labels INSIDE the area */
            /* padding: var(--label-size) 0 0 var(--label-size); */
            /* Let wrapper handle spacing */
        }

        .board-wrapper {
            display: grid;
            /* æ ‡ç­¾ + æ£‹ç›˜çš„æ¨¡æ¿ */
            grid-template-columns: var(--label-size) var(--board-dimension);
            grid-template-rows: var(--label-size) var(--board-dimension);
            align-items: stretch; /* ä½¿æ ‡ç­¾ä¼¸å±• */
            justify-items: stretch; /* ä½¿æ ‡ç­¾ä¼¸å±• */
            /* Add some margin around the whole wrapper if needed */
            /* margin-bottom: 15px; */
        }

        .board-labels-top {
            grid-column: 2 / 3; /* æ£‹ç›˜ä¸Šæ–¹ */
            grid-row: 1 / 2;
            display: flex;
            /* ä½¿ç”¨ space-around åœ¨å•å…ƒæ ¼ç©ºé—´å†…å±…ä¸­ */
            justify-content: space-around;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.4);
            color: #555;
            /* Align text with grid centers */
            /* padding-left: calc(var(--cell-size) / 2); */
            /* padding-right: calc(var(--cell-size) / 2); */
        }
        .board-labels-left {
            grid-column: 1 / 2; /* æ£‹ç›˜å·¦ä¾§ */
            grid-row: 2 / 3;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            align-items: center;
            font-size: calc(var(--cell-size) * 0.4);
            color: #555;
             /* Align text with grid centers */
            /* padding-top: calc(var(--cell-size) / 2); */
            /* padding-bottom: calc(var(--cell-size) / 2); */
        }
        /* ç¡®ä¿æ ‡ç­¾æ­£ç¡®å æ®ç©ºé—´ */
        .board-labels-top span, .board-labels-left span {
            display: flex;
            justify-content: center;
            align-items: center;
            width: var(--cell-size); /* åŒ¹é…å•å…ƒæ ¼å®½åº¦ */
            height: var(--cell-size); /* åŒ¹é…å•å…ƒæ ¼é«˜åº¦ */
        }

        #game-board {
            grid-column: 2 / 3; /* æ£‹ç›˜æœ¬èº« */
            grid-row: 2 / 3;
            width: var(--board-dimension);
            height: var(--board-dimension);
            display: grid;
            grid-template-columns: repeat(var(--board-size), 1fr);
            grid-template-rows: repeat(var(--board-size), 1fr);
            border: 2px solid #8B4513; /* æœ¨è´¨è¾¹æ¡† */
            background-color: #F5DEB3; /* æœ¨è´¨èƒŒæ™¯ */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative; /* ç”¨äºä¼ªå…ƒç´  */
            overflow: hidden; /* ç¡®ä¿æ£‹å­åœ¨è§†è§‰ä¸Šä¸æº¢å‡º */
        }

        /* ä½¿ç”¨ä¼ªå…ƒç´ ç»˜åˆ¶ç½‘æ ¼çº¿ */
         #game-board::before {
            content: '';
            position: absolute;
            /* ä»ç¬¬ä¸€ä¸ªå•å…ƒæ ¼çš„ä¸­å¿ƒå¼€å§‹ç»˜åˆ¶çº¿æ¡ */
            top: calc(var(--cell-size) / 2);
            left: calc(var(--cell-size) / 2);
            /* çº¿æ¡åº”è¦†ç›–å†…éƒ¨ç½‘æ ¼äº¤å‰ç‚¹ */
            width: calc(var(--board-dimension) - var(--cell-size));
            height: calc(var(--board-dimension) - var(--cell-size));
            background-image:
                linear-gradient(to right, #aaa 1px, transparent 1px),
                linear-gradient(to bottom, #aaa 1px, transparent 1px);
            background-size: var(--cell-size) var(--cell-size);
            z-index: 0; /* åœ¨å•å…ƒæ ¼åé¢ */
        }

        .cell {
            position: relative; /* ç”¨äºæ£‹å­å®šä½ */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1; /* åœ¨ç½‘æ ¼çº¿ä¹‹ä¸Š */
        }

        /* ç©ºå•å…ƒæ ¼çš„æ‚¬åœæ•ˆæœ */
        .cell:not(.occupied):hover::after {
            content: '';
            position: absolute;
            width: 70%;
            height: 70%;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.1);
            pointer-events: none; /* å…è®¸ç‚¹å‡»ç©¿é€ */
        }

        /* å·²å ç”¨çš„å•å…ƒæ ¼ä¸éœ€è¦æ‚¬åœæ•ˆæœ */
        /* .cell.occupied:hover::after { display: none; } */

        .piece {
            width: 80%;
            height: 80%;
            border-radius: 50%;
            position: absolute; /* åœ¨å•å…ƒæ ¼å†…å±…ä¸­ */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: scale(0); /* åŠ¨ç”»çš„åˆå§‹çŠ¶æ€ */
            animation: placePiece 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 2; /* æ£‹å­åœ¨ç½‘æ ¼çº¿å’Œæ‚¬åœæ•ˆæœä¹‹ä¸Š */
        }

        .piece.black { background: radial-gradient(circle at 30% 30%, #555, #000); }
        .piece.white { background: radial-gradient(circle at 70% 70%, #fff, #ccc); }

        @keyframes placePiece {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- æ§åˆ¶å’Œè®¾ç½®é¢æ¿ --- */
        .controls-and-logs {
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
            min-width: 320px; /* æ§åˆ¶é¢æ¿çš„æœ€å°å®½åº¦ */
            max-width: 500px; /* æ§åˆ¶é¢æ¿çš„æœ€å¤§å®½åº¦ */
        }

        .panel {
            background-color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px; /* é¢æ¿ä¹‹é—´çš„è¾¹è· */
        }

        .panel h3 {
            margin: -15px -20px 15px -20px; /* æ‰©å±•æ ‡é¢˜èƒŒæ™¯ */
            padding: 10px 20px;
            background-color: #e9ecef;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border-bottom: 1px solid #dee2e6;
            color: #495057;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         .panel h3 button.toggle-btn {
             background: none;
             border: none;
             font-size: 1em;
             cursor: pointer;
             padding: 0 5px;
             color: #6c757d;
         }

        .form-group { margin-bottom: 12px; }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea { /* æ·»åŠ äº† textarea */
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95em;
            transition: border-color 0.2s ease;
        }
        .form-group textarea {
            min-height: 60px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
             border-color: #1a73e8;
             outline: none;
        }
        .form-group input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
        }
        .form-group small {
            font-size: 0.8em;
            color: #6c757d;
            display: block;
            margin-top: 3px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; /* éœ€è¦æ—¶æ¢è¡ŒæŒ‰é’® */
        }
        /* æ—¥å¿—æ§åˆ¶çš„ç‰¹å®šç»„ */
        .log-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            background-color: #1a73e8;
            color: white;
        }
        button:hover {
            background-color: #155ab6;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        button:active { background-color: #124a9c; }
        button#new-game-btn { background-color: #28a745; }
        button#new-game-btn:hover { background-color: #218838; }
        button#ai-first-btn { background-color: #17a2b8; } /* AI å…ˆè¡Œçš„ä¸åŒé¢œè‰² */
        button#ai-first-btn:hover { background-color: #138496; }
        button#ai-retry-btn { background-color: #ffc107; color: #333; } /* è­¦å‘Šè‰² */
        button#ai-retry-btn:hover { background-color: #e0a800; }
        button.secondary-btn { background-color: #6c757d; }
        button.secondary-btn:hover { background-color: #5a6268; }
        button.danger-btn { background-color: #dc3545; }
        button.danger-btn:hover { background-color: #c82333; }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.7;
        }

        /* --- çŠ¶æ€å’Œæ—¥å¿—åŒºåŸŸ --- */
        #status-area {
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            font-size: 1.1em;
            min-height: 1.5em; /* é˜²æ­¢å¸ƒå±€æŠ–åŠ¨ */
            color: #0056b3;
        }

        #log-area {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
            height: 250px; /* å¢åŠ é«˜åº¦ */
            overflow-y: auto;
            font-size: 0.85em;
            line-height: 1.5;
            color: #444;
        }
        #log-area p { margin-bottom: 5px; word-wrap: break-word; }
        #log-area .log-info { color: #333; }
        #log-area .log-success { color: #28a745; }
        #log-area .log-error { color: #dc3545; font-weight: bold; }
        #log-area .log-warning { color: #ffc107; }
        #log-area .log-api { color: #007bff; }
        #log-area .log-ai-resp {
            color: #6c757d;
            font-style: italic;
            white-space: pre-wrap; /* ä¿ç•™ç©ºç™½ç¬¦ */
            border-left: 3px solid #ccc;
            padding-left: 8px;
            margin-top: 2px;
            display: none; /* é»˜è®¤éšè— */
        }
        #log-area.show-raw-ai .log-ai-resp { display: block; } /* æ·»åŠ ç±»æ—¶æ˜¾ç¤º */

        /* --- éšè—çš„ Canvas --- */
        #board-canvas { display: none; }

        /* --- å“åº”å¼è°ƒæ•´ --- */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .main-content { flex-direction: column; align-items: center; }
            .controls-and-logs { width: 100%; max-width: none; }
            /* åœ¨è¾ƒå°å±å¹•ä¸Šæ›´ç§¯æåœ°è°ƒæ•´å•å…ƒæ ¼/æ ‡ç­¾å¤§å° */
            .board-area { --cell-size: clamp(18px, 5.5vw, 28px); --label-size: 18px; }
            .board-labels-top, .board-labels-left { font-size: calc(var(--cell-size) * 0.5); }
            .panel h3 { font-size: 1em; }
            button { font-size: 0.9em; padding: 8px 12px;}
            #log-area { height: 200px; }
            .log-controls { flex-direction: column; align-items: flex-start; gap: 5px;} /* å †å æ—¥å¿—æ§ä»¶ */
        }
         @media (max-width: 480px) {
             .board-area { --cell-size: clamp(16px, 5vw, 22px); --label-size: 15px; }
             .board-labels-top, .board-labels-left { font-size: calc(var(--cell-size) * 0.55); }
         }

        /* --- è®¾ç½®éƒ¨åˆ† --- */
        .settings-section {
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fdfdfd;
        }
        .settings-section h4 {
            margin-bottom: 10px;
            font-size: 1em;
            color: #333;
        }

    </style>
</head>
<body>
    <h1>AI äº”å­æ£‹å¯¹æˆ˜ v1</h1> {/* ç‰ˆæœ¬ä¿®æ”¹ */}

    <div class="game-container">
        <div id="status-area">è¯·å¼€å§‹æ¸¸æˆ</div>

        <div class="main-content">
            <div class="board-area">
                <!-- æ£‹ç›˜å’Œæ ‡ç­¾çš„åŒ…è£…å™¨ -->
                <div class="board-wrapper">
                    <div class="board-labels-top"></div> <!-- åˆ—æ ‡ç­¾ (A-O) -->
                    <div class="board-labels-left"></div> <!-- è¡Œæ ‡ç­¾ (0-14) -->
                    <div id="game-board"></div>         <!-- å®é™…çš„æ¸¸æˆæ£‹ç›˜ -->
                </div>
                <canvas id="board-canvas"></canvas> <!-- éšè—çš„ canvas -->
            </div>

            <div class="controls-and-logs">

                <!-- API é…ç½®é¢æ¿ -->
                <div class="panel">
                    <h3>
                        <span>âš™ï¸ API é…ç½®ç®¡ç†</span>
                        <button class="toggle-btn" id="toggle-api-config" title="Toggle Panel">(-)</button>
                    </h3>
                    <div id="api-config-content">
                        <div class="form-group">
                            <label for="api-config-select">é€‰æ‹©é…ç½®:</label>
                            <select id="api-config-select"></select>
                        </div>

                        <div class="settings-section">
                             <h4>ç¼–è¾‘/æ·»åŠ é…ç½®</h4>
                             <div class="form-group">
                                 <label for="api-config-name">é…ç½®åç§°:</label>
                                 <input type="text" id="api-config-name" placeholder="ä¾‹å¦‚: My Gemini Config">
                             </div>
                             <div class="form-group">
                                 <label for="api-url">API åœ°å€:</label>
                                 <input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1/chat/completions">
                                 <small>è¾“å…¥æ‚¨çš„ API ç«¯ç‚¹ URL</small> {/* æç¤ºç”¨æˆ·è¾“å…¥ */}
                             </div>
                             <div class="form-group">
                                 <label for="api-key">API Key:</label>
                                 <input type="password" id="api-key" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„ API Key"> {/* æç¤ºç”¨æˆ·è¾“å…¥ */}
                             </div>
                             <div class="form-group">
                                 <label for="api-models-list">å¯ç”¨æ¨¡å‹ (é€—å·åˆ†éš”):</label>
                                 <textarea id="api-models-list" rows="2" placeholder="ä¾‹å¦‚: gpt-4o, gemini-1.5-pro-latest"></textarea> {/* æç¤ºç”¨æˆ·è¾“å…¥ */}
                                 <small>åœ¨æ­¤å¤„è¾“å…¥æ­¤é…ç½®å¯ç”¨çš„æ¨¡å‹åç§°</small>
                             </div>
                             <div class="button-group">
                                 <button id="save-api-config-btn" class="secondary-btn">ä¿å­˜å¯¹é€‰ä¸­é…ç½®çš„æ›´æ”¹</button>
                                 <button id="add-api-config-btn">æ·»åŠ ä¸ºæ–°é…ç½®</button>
                                 <button id="delete-api-config-btn" class="danger-btn">åˆ é™¤é€‰ä¸­é…ç½®</button>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆè®¾ç½®é¢æ¿ -->
                <div class="panel">
                     <h3>
                         <span>ğŸ® æ¸¸æˆè®¾ç½®</span>
                         <button class="toggle-btn" id="toggle-game-settings" title="Toggle Panel">(-)</button>
                    </h3>
                    <div id="game-settings-content">
                        <div class="form-group">
                            <label for="api-model">é€‰æ‹©æ¨¡å‹ (æ¥è‡ªå½“å‰APIé…ç½®):</label>
                            <select id="api-model">
                                <!-- é€‰é¡¹ç”± JS å¡«å…… -->
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="use-image">
                                <input type="checkbox" id="use-image"> ä½¿ç”¨å›¾åƒæ¨¡å¼ (éœ€è¦æ¨¡å‹æ”¯æŒVision)
                            </label>
                             <small>å›¾åƒæ¨¡å¼ä¼šåŒ…å«æ£‹ç›˜åæ ‡æ ‡è®°ã€‚</small>
                        </div>
                        <div class="form-group">
                            <label for="temperature">Temperature:</label>
                            <input type="number" id="temperature" min="0" max="2" step="0.1" value="0.1"> {/* é»˜è®¤å€¼ä¿®æ”¹ */}
                        </div>
                        <div class="form-group">
                            <label for="max-tokens">Max Tokens:</label>
                            <input type="number" id="max-tokens" min="10" max="60000" step="10" value="60000"> {/* é»˜è®¤å€¼å’Œ max ä¿®æ”¹ */}
                        </div>
                         <div class="form-group">
                            <label for="move-wrapper">AIè½å­æ ‡è®° (ç”¨ [row],[col] ä»£è¡¨è¡Œåˆ—):</label>
                            <input type="text" id="move-wrapper" value="AI_MOVE:[row],[col]">
                            <small>ä¾‹å¦‚: `AI_MOVE:[row],[col]` æˆ– `è½å­:[row],[col]`ã€‚åæ ‡ä»0å¼€å§‹ã€‚</small>
                        </div>
                        <div class="button-group">
                            <button id="save-game-settings-btn">ä¿å­˜æ¸¸æˆè®¾ç½®</button>
                             <small style="align-self: center;">(APIé…ç½®åœ¨ä¸Šæ–¹å•ç‹¬ä¿å­˜)</small>
                        </div>
                    </div>
                </div>

                <!-- æ¸¸æˆæ§åˆ¶ -->
                 <div class="panel">
                     <h3>ğŸ•¹ï¸ æ¸¸æˆæ§åˆ¶</h3>
                     <div class="button-group">
                         <button id="new-game-btn">æ–°æ¸¸æˆ (ç©å®¶å…ˆæ‰‹)</button>
                         <button id="ai-first-btn">æ–°æ¸¸æˆ (AI å…ˆæ‰‹)</button>
                         <button id="ai-retry-btn" disabled>AI é‡è¯•</button> <!-- åˆå§‹ç¦ç”¨ -->
                     </div>
                 </div>

                <!-- æ—¥å¿—åŒºåŸŸ -->
                <div class="panel">
                    <h3>
                        <span>ğŸ“Š æ—¥å¿— & AI å›å¤</span>
                         <button class="toggle-btn" id="toggle-log-panel" title="Toggle Panel">(-)</button>
                    </h3>
                     <div id="log-panel-content">
                         <div class="log-controls"> <!-- æ—¥å¿—æ§åˆ¶çš„æ–°å®¹å™¨ -->
                             <div class="form-group" style="margin-bottom: 0;">
                                 <label for="show-raw-ai-response" style="font-weight: normal; font-size: 0.9em;">
                                     <input type="checkbox" id="show-raw-ai-response"> æ˜¾ç¤º AI åŸå§‹å›å¤
                                 </label>
                             </div>
                             <button id="clear-log-btn" class="secondary-btn" style="padding: 5px 10px; font-size: 0.85em;">æ¸…é™¤æ—¥å¿—</button>
                         </div>
                        <div id="log-area">
                            <p class="log-info">æ¬¢è¿æ¥åˆ° AI äº”å­æ£‹ v1!</p> {/* ç‰ˆæœ¬ä¿®æ”¹ */}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM å…ƒç´  ---
        const boardElement = document.getElementById('game-board');
        const boardLabelsTop = document.querySelector('.board-labels-top'); // æ·»åŠ  - é¡¶éƒ¨æ ‡ç­¾å®¹å™¨
        const boardLabelsLeft = document.querySelector('.board-labels-left'); // æ·»åŠ  - å·¦ä¾§æ ‡ç­¾å®¹å™¨
        const statusArea = document.getElementById('status-area');
        const logArea = document.getElementById('log-area');
        const newGameBtn = document.getElementById('new-game-btn');
        const aiFirstBtn = document.getElementById('ai-first-btn');
        const aiRetryBtn = document.getElementById('ai-retry-btn'); // æ·»åŠ  - AI é‡è¯•æŒ‰é’®
        const boardCanvas = document.getElementById('board-canvas');
        const ctx = boardCanvas.getContext('2d');

        // API é…ç½®å…ƒç´ 
        const apiConfigSelect = document.getElementById('api-config-select');
        const apiConfigNameInput = document.getElementById('api-config-name');
        const apiUrlInput = document.getElementById('api-url');
        const apiKeyInput = document.getElementById('api-key');
        const apiModelsListInput = document.getElementById('api-models-list');
        const saveApiConfigBtn = document.getElementById('save-api-config-btn');
        const addApiConfigBtn = document.getElementById('add-api-config-btn');
        const deleteApiConfigBtn = document.getElementById('delete-api-config-btn');
        const toggleApiConfigBtn = document.getElementById('toggle-api-config');
        const apiConfigContent = document.getElementById('api-config-content');

        // æ¸¸æˆè®¾ç½®å…ƒç´ 
        const apiModelSelect = document.getElementById('api-model');
        const useImageCheckbox = document.getElementById('use-image');
        const temperatureInput = document.getElementById('temperature');
        const maxTokensInput = document.getElementById('max-tokens');
        const moveWrapperInput = document.getElementById('move-wrapper');
        const saveGameSettingsBtn = document.getElementById('save-game-settings-btn');
        const toggleGameSettingsBtn = document.getElementById('toggle-game-settings');
        const gameSettingsContent = document.getElementById('game-settings-content');

        // æ—¥å¿—å…ƒç´ 
        const showRawAiResponseCheckbox = document.getElementById('show-raw-ai-response');
        const toggleLogPanelBtn = document.getElementById('toggle-log-panel');
        const logPanelContent = document.getElementById('log-panel-content');
        const clearLogBtn = document.getElementById('clear-log-btn'); // æ·»åŠ  - æ¸…é™¤æ—¥å¿—æŒ‰é’®


        // --- æ¸¸æˆçŠ¶æ€ ---
        const BOARD_SIZE = 15; // æ£‹ç›˜å¤§å° (15x15)
        let board = []; // æ£‹ç›˜çŠ¶æ€æ•°ç»„: 0: ç©º, 1: ç©å®¶ (é»‘æ£‹), 2: AI (ç™½æ£‹) - æˆ–è€…æ ¹æ® aiStarts åˆ‡æ¢
        let humanPlayer = 1; // äººç±»ç©å®¶æ£‹å­ç±»å‹ (é»˜è®¤é»‘æ£‹ 1)
        let aiPlayer = 2;     // AI ç©å®¶æ£‹å­ç±»å‹ (é»˜è®¤ç™½æ£‹ 2)
        let currentPlayer = 1; // å½“å‰è½®åˆ°è°ä¸‹æ£‹
        let gameOver = false; // æ¸¸æˆæ˜¯å¦ç»“æŸ
        let aiIsThinking = false; // AI æ˜¯å¦æ­£åœ¨æ€è€ƒ
        let aiCanRetry = false; // æ ‡å¿—ä½ï¼ŒæŒ‡ç¤º AI æ˜¯å¦å¯ä»¥é‡è¯• (ä»…åœ¨ AI å¤±è´¥æ—¶è®¾ç½®ä¸º true)

        // --- è®¾ç½® ---
        let apiConfigs = []; // API é…ç½®æ•°ç»„ { name: string, url: string, key: string, models: string[] }
        let selectedConfigName = ''; // å½“å‰é€‰ä¸­çš„ API é…ç½®åç§°
        let gameSettings = { // æ¸¸æˆç›¸å…³è®¾ç½®
            selectedModel: '', // ä»å½“å‰é…ç½®çš„æ¨¡å‹åˆ—è¡¨ä¸­é€‰æ‹©çš„æ¨¡å‹
            useImage: false, // æ˜¯å¦ä½¿ç”¨å›¾åƒæ¨¡å¼
            temperature: 0.1, // æ¸©åº¦ (é»˜è®¤å€¼ä¿®æ”¹)
            maxTokens: 60000, // æœ€å¤§ Token æ•° (é»˜è®¤å€¼ä¿®æ”¹)
            moveWrapper: 'AI_MOVE:[row],[col]', // AI å›å¤è½å­ä½ç½®çš„æ ¼å¼åŒ…è£…å™¨
            showRawResponse: false, // æ˜¯å¦åœ¨æ—¥å¿—ä¸­æ˜¾ç¤º AI åŸå§‹å›å¤
            retryAttempts: 3, // triggerAIMove è°ƒç”¨ä¸­ API é”™è¯¯çš„æœ€å¤šé‡è¯•æ¬¡æ•°
            retryDelay: 1500 // API è°ƒç”¨é‡è¯•ä¹‹é—´çš„å»¶è¿Ÿ (æ¯«ç§’)
        };

        // --- åˆå§‹åŒ– ---
        function initGame(aiStarts = false) {
            // åˆå§‹åŒ–æ£‹ç›˜æ•°ç»„ï¼Œæ‰€æœ‰ä½ç½®è®¾ä¸º 0 (ç©º)
            board = Array(BOARD_SIZE).fill(0).map(() => Array(BOARD_SIZE).fill(0));
            gameOver = false; // é‡ç½®æ¸¸æˆç»“æŸçŠ¶æ€
            aiIsThinking = false; // é‡ç½® AI æ€è€ƒçŠ¶æ€
            aiCanRetry = false; // æ–°æ¸¸æˆæ—¶é‡ç½®é‡è¯•æ ‡å¿—
            aiRetryBtn.disabled = true; // æ–°æ¸¸æˆæ—¶ç¦ç”¨é‡è¯•æŒ‰é’®

            if (aiStarts) {
                humanPlayer = 2; // äººç±»æ‰§ç™½
                aiPlayer = 1;    // AI æ‰§é»‘
                currentPlayer = aiPlayer; // AI å…ˆè¡Œ
                updateStatus("æ–°æ¸¸æˆï¼šAI å…ˆè¡Œ (é»‘æ£‹)");
                logMessage("æ–°æ¸¸æˆå¼€å§‹ï¼AI ä½¿ç”¨é»‘æ£‹å…ˆè¡Œã€‚", "info");
                disableBoardInteraction(); // ç¦ç”¨æ£‹ç›˜äº¤äº’
                disableGameButtons(); // ç¦ç”¨æ–°æ¸¸æˆæŒ‰é’®
                 setTimeout(triggerAIMove, 500); // ç¨ä½œå»¶è¿Ÿåè§¦å‘ AI è¡ŒåŠ¨
            } else {
                humanPlayer = 1; // äººç±»æ‰§é»‘
                aiPlayer = 2;    // AI æ‰§ç™½
                currentPlayer = humanPlayer; // ç©å®¶å…ˆè¡Œ
                updateStatus("æ–°æ¸¸æˆï¼šç©å®¶å…ˆè¡Œ (é»‘æ£‹)");
                logMessage("æ–°æ¸¸æˆå¼€å§‹ï¼ç©å®¶ä½¿ç”¨é»‘æ£‹å…ˆè¡Œã€‚", "info");
                enableBoardInteraction(); // å¯ç”¨æ£‹ç›˜äº¤äº’
                enableGameButtons(); // å¯ç”¨æ–°æ¸¸æˆæŒ‰é’®
            }
            drawBoard(); // ç»˜åˆ¶æ£‹ç›˜ï¼ˆåœ¨è®¾ç½®ç©å®¶å’Œæ ‡ç­¾åï¼‰
            drawLabels(); // ç»˜åˆ¶è¡Œåˆ—æ ‡ç­¾
        }

        // ç»˜åˆ¶æ£‹ç›˜çš„è¡Œåˆ—æ ‡ç­¾ (A-O, 0-14)
        function drawLabels() {
            boardLabelsTop.innerHTML = ''; // æ¸…ç©ºé¡¶éƒ¨æ ‡ç­¾
            boardLabelsLeft.innerHTML = ''; // æ¸…ç©ºå·¦ä¾§æ ‡ç­¾
            // åˆ—æ ‡ç­¾ (A-O) - ä¸æ—¥å¿—å’Œ AI æç¤ºä¿æŒä¸€è‡´
            for (let c = 0; c < BOARD_SIZE; c++) {
                const label = document.createElement('span');
                label.textContent = String.fromCharCode(65 + c); // A, B, C...O
                boardLabelsTop.appendChild(label);
            }
            // è¡Œæ ‡ç­¾ (0-14) - ä¸æ—¥å¿—å’Œ AI æç¤ºä¿æŒä¸€è‡´
            for (let r = 0; r < BOARD_SIZE; r++) {
                const label = document.createElement('span');
                label.textContent = r; // 0, 1, 2...14
                boardLabelsLeft.appendChild(label);
            }
        }

        // ç»˜åˆ¶æ¸¸æˆæ£‹ç›˜
        function drawBoard() {
            boardElement.innerHTML = ''; // æ¸…ç©ºæ£‹ç›˜å†…å®¹
            // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åŠ¨æ€è®¾ç½® CSS å˜é‡ (å·²åœ¨ CSS ä¸­è®¾ç½®)
            // boardElement.style.setProperty('--board-size', BOARD_SIZE);

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('cell');
                    cell.dataset.row = r; // å­˜å‚¨è¡Œå· (0-14)
                    cell.dataset.col = c; // å­˜å‚¨åˆ—å· (0-14)

                    if (board[r][c] !== 0) { // å¦‚æœæ ¼å­éç©º
                        cell.classList.add('occupied'); // æ ‡è®°ä¸ºå·²å ç”¨
                        const piece = document.createElement('div');
                        piece.classList.add('piece');
                        // ä½¿ç”¨ 1 ä»£è¡¨é»‘æ£‹, 2 ä»£è¡¨ç™½æ£‹
                        piece.classList.add(board[r][c] === 1 ? 'black' : 'white');
                        cell.appendChild(piece);
                    } else if (!gameOver && currentPlayer === humanPlayer && !aiIsThinking) {
                        // ä»…å½“è½®åˆ°ç©å®¶ã€æ¸¸æˆæœªç»“æŸã€AI æœªæ€è€ƒæ—¶ï¼Œä¸ºç©ºæ ¼å­æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨
                        cell.addEventListener('click', handleCellClick);
                    }
                    boardElement.appendChild(cell);
                }
            }
             // ç¡®ä¿æ§ä»¶åæ˜ å½“å‰çŠ¶æ€
             updateControlStates();
        }

        // --- æ¸¸æˆé€»è¾‘ ---
        // å¤„ç†ç©å®¶ç‚¹å‡»æ£‹ç›˜æ ¼å­çš„äº‹ä»¶
        function handleCellClick(event) {
            // å¦‚æœæ¸¸æˆç»“æŸã€AI æ­£åœ¨æ€è€ƒæˆ–ä¸æ˜¯ç©å®¶çš„å›åˆï¼Œåˆ™å¿½ç•¥ç‚¹å‡»
            if (gameOver || aiIsThinking || currentPlayer !== humanPlayer) return;

            const cell = event.target.closest('.cell'); // è·å–è¢«ç‚¹å‡»çš„ cell å…ƒç´ 
            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯ cell æˆ– cell å·²è¢«å ç”¨ï¼Œåˆ™å¿½ç•¥
            if (!cell || cell.classList.contains('occupied')) return;

            const row = parseInt(cell.dataset.row); // è·å–è¡Œå·
            const col = parseInt(cell.dataset.col); // è·å–åˆ—å·

            // å†æ¬¡æ£€æŸ¥æ ¼å­æ˜¯å¦ä¸ºç©º (è™½ç„¶ classList æ£€æŸ¥é€šå¸¸è¶³å¤Ÿ)
            if (board[row][col] === 0) {
                // ç©å®¶æˆåŠŸè½å­ã€‚
                // ä»»ä½•ä¹‹å‰çš„ AI å¤±è´¥çŠ¶æ€ç°åœ¨éƒ½æ— å…³ç´§è¦ï¼Œç¦ç”¨é‡è¯•ã€‚
                aiCanRetry = false;
                // æ”¾ç½®æ£‹å­å¹¶ç»§ç»­
                placePiece(row, col, humanPlayer);
                // ç©å®¶è½å­åç«‹å³æ›´æ–°æ§ä»¶çŠ¶æ€ (ç¦ç”¨é‡è¯•æŒ‰é’®)
                updateControlStates();
            }
        }

        // åœ¨æŒ‡å®šä½ç½®æ”¾ç½®æ£‹å­
        function placePiece(row, col, player) {
            // åŸºæœ¬éªŒè¯ï¼šæ¸¸æˆæ˜¯å¦ç»“æŸï¼Œåæ ‡æ˜¯å¦è¶Šç•Œï¼Œä½ç½®æ˜¯å¦ä¸ºç©º
            if (gameOver || row < 0 || row >= BOARD_SIZE || col < 0 || col >= BOARD_SIZE || board[row][col] !== 0) {
                return false; // æ— æ•ˆç§»åŠ¨
            }

            board[row][col] = player; // æ›´æ–°æ£‹ç›˜çŠ¶æ€æ•°ç»„
            const pieceColor = player === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'; // è·å–æ£‹å­é¢œè‰²
            const playerType = player === humanPlayer ? 'ç©å®¶' : 'AI'; // è·å–ç©å®¶ç±»å‹
            // ä½¿ç”¨ä¸¤ç§åæ ‡ç³»è®°å½•æ—¥å¿—ä»¥ä¾¿æ¸…æ™°æŸ¥çœ‹
            logMessage(`${playerType} (${pieceColor}) è½å­äº [${row}, ${col}] (åæ ‡ ${String.fromCharCode(65 + col)}${row})`, "info");

            // é‡æ–°ç»˜åˆ¶æ•´ä¸ªæ£‹ç›˜ä»¥æ­£ç¡®æ›´æ–°è§†è§‰æ•ˆæœå’Œç›‘å¬å™¨
            // è¿™ä¼šéšå¼åœ°ç§»é™¤æ–°å ç”¨å•å…ƒæ ¼çš„ç›‘å¬å™¨
            drawBoard(); // drawBoard ä¼šè°ƒç”¨ updateControlStates

            // æ£€æŸ¥å½“å‰ç©å®¶æ˜¯å¦è·èƒœ
            if (checkWin(row, col, player)) {
                gameOver = true; // æ ‡è®°æ¸¸æˆç»“æŸ
                const winner = player === humanPlayer ? "æ­å–œä½ ï¼Œä½ èµ¢äº†ï¼ğŸ‰" : "AI è·èƒœï¼ğŸ¤–";
                updateStatus(winner); // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                logMessage(`æ¸¸æˆç»“æŸï¼š${winner}`, "success"); // è®°å½•æ—¥å¿—
                aiCanRetry = false; // æ¸¸æˆç»“æŸåä¸èƒ½é‡è¯•
                disableBoardInteraction(); // ç¦ç”¨æ£‹ç›˜äº¤äº’
                disableGameButtons(); // ä¿æŒæ–°æ¸¸æˆæŒ‰é’®ç¦ç”¨ï¼Œç›´åˆ°æ˜ç¡®å¯ç”¨
                aiRetryBtn.disabled = true; // ç¡®ä¿æ¸¸æˆç»“æŸæ—¶ç¦ç”¨é‡è¯•
                return true;
            }

            // æ£€æŸ¥æ˜¯å¦å¹³å±€
            if (checkDraw()) {
                gameOver = true; // æ ‡è®°æ¸¸æˆç»“æŸ
                updateStatus("å¹³å±€ï¼ğŸ¤"); // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                logMessage("æ¸¸æˆç»“æŸï¼šå¹³å±€ï¼", "warning"); // è®°å½•æ—¥å¿—
                aiCanRetry = false; // æ¸¸æˆç»“æŸåä¸èƒ½é‡è¯•
                disableBoardInteraction(); // ç¦ç”¨æ£‹ç›˜äº¤äº’
                disableGameButtons(); // ç¦ç”¨æ¸¸æˆæŒ‰é’®
                aiRetryBtn.disabled = true; // ç¡®ä¿æ¸¸æˆç»“æŸæ—¶ç¦ç”¨é‡è¯•
                return true;
            }

            // å¦‚æœæ¸¸æˆæœªç»“æŸï¼Œåˆ™åˆ‡æ¢ç©å®¶
            if (!gameOver) {
                switchPlayer();
            }
            return true; // è½å­æˆåŠŸ
        }

        // åˆ‡æ¢å½“å‰ç©å®¶
        function switchPlayer() {
            currentPlayer = (currentPlayer === humanPlayer) ? aiPlayer : humanPlayer; // åˆ‡æ¢ç©å®¶
            const currentPieceColor = currentPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'; // è·å–å½“å‰ç©å®¶æ£‹å­é¢œè‰²

            if (currentPlayer === aiPlayer) { // å¦‚æœè½®åˆ° AI
                updateStatus(`AI (${currentPieceColor}) æ€è€ƒä¸­...`); // æ›´æ–°çŠ¶æ€
                aiIsThinking = true; // æ ‡è®° AI æ­£åœ¨æ€è€ƒ
                aiCanRetry = false; // AI å¼€å§‹å›åˆæ—¶é‡ç½®é‡è¯•å¯èƒ½æ€§
                disableBoardInteraction(); // ç¦ç”¨æ£‹ç›˜äº¤äº’
                disableGameButtons(); // ç¦ç”¨æ¸¸æˆæŒ‰é’®
                aiRetryBtn.disabled = true; // AI æ€è€ƒæ—¶ç¦ç”¨é‡è¯•
                setTimeout(triggerAIMove, 300); // çŸ­æš‚å»¶è¿Ÿåè°ƒç”¨ AI
            } else { // å¦‚æœè½®åˆ°äººç±»ç©å®¶
                // AI ç§»åŠ¨åæˆåŠŸåˆ‡æ¢åˆ°äººç±»ç©å®¶
                updateStatus(`è½®åˆ°ä½ äº† (${currentPieceColor})`); // æ›´æ–°çŠ¶æ€
                aiIsThinking = false; // ç¡®ä¿é‡ç½®æ€è€ƒæ ‡å¿—
                // aiCanRetry åœ¨è¿™é‡Œä¿æŒ false (ä»…åœ¨ AI å¤±è´¥æ—¶é€šè¿‡ handleInvalidAIMove è®¾ç½®ä¸º true)
                enableBoardInteraction(); // ä¸ºäººç±»å¯ç”¨æ§ä»¶
                enableGameButtons(); // å¯ç”¨æ¸¸æˆæŒ‰é’®
                // é‡æ–°ç»˜åˆ¶æ£‹ç›˜ï¼Œå°†ç‚¹å‡»ç›‘å¬å™¨åŠ å›ç©ºæ ¼å­
                drawBoard(); // drawBoard è°ƒç”¨ updateControlStatesï¼Œåè€…å¤„ç†é‡è¯•æŒ‰é’®
            }
        }

        // æ£€æŸ¥æŒ‡å®šä½ç½®è½å­åæ˜¯å¦è·èƒœ
        function checkWin(row, col, player) {
            // æ£€æŸ¥æ°´å¹³ã€å‚ç›´å’Œä¸¤ä¸ªå¯¹è§’çº¿æ–¹å‘
            const directions = [
                { dr: 0, dc: 1 }, // æ°´å¹³
                { dr: 1, dc: 0 }, // å‚ç›´
                { dr: 1, dc: 1 }, // ä¸»å¯¹è§’çº¿
                { dr: 1, dc: -1 } // å‰¯å¯¹è§’çº¿
            ];
            for (const { dr, dc } of directions) {
                let count = 1; // è®¡ç®—åˆšä¸‹çš„æ£‹å­
                // æ£€æŸ¥æ­£æ–¹å‘
                for (let i = 1; i < 5; i++) {
                    const nr = row + i * dr;
                    const nc = col + i * dc;
                    if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === player) {
                        count++;
                    } else {
                        break; // é‡åˆ°è¾¹ç•Œæˆ–ä¸åŒæ£‹å­åˆ™åœæ­¢
                    }
                }
                // æ£€æŸ¥è´Ÿæ–¹å‘
                for (let i = 1; i < 5; i++) {
                    const nr = row - i * dr;
                    const nc = col - i * dc;
                    if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE && board[nr][nc] === player) {
                        count++;
                    } else {
                        break; // é‡åˆ°è¾¹ç•Œæˆ–ä¸åŒæ£‹å­åˆ™åœæ­¢
                    }
                }
                if (count >= 5) return true; // å¦‚æœè¿å­æ•°è¾¾åˆ° 5 æˆ–ä»¥ä¸Šï¼Œè¿”å› true
            }
            return false; // æ‰€æœ‰æ–¹å‘æ£€æŸ¥å®Œæ¯•ï¼Œæœªè·èƒœ
        }

        // æ£€æŸ¥æ˜¯å¦å¹³å±€ (æ£‹ç›˜æ˜¯å¦å·²æ»¡)
        function checkDraw() {
            // æ£€æŸ¥æ£‹ç›˜ä¸Šæ˜¯å¦æ‰€æœ‰æ ¼å­éƒ½éç©º
            return board.every(row => row.every(cell => cell !== 0));
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸçš„æ–‡æœ¬
        function updateStatus(message) {
            statusArea.textContent = message;
        }

        // --- æ§åˆ¶çŠ¶æ€ç®¡ç† ---
        // ç¦ç”¨æ£‹ç›˜äº¤äº’
        function disableBoardInteraction() {
             boardElement.style.cursor = 'not-allowed'; // è®¾ç½®é¼ æ ‡æ ·å¼ä¸ºä¸å…è®¸
             // é€šè¿‡é‡æ–°ç»˜åˆ¶è€Œä¸æ·»åŠ ç›‘å¬å™¨æ¥ç§»é™¤ç›‘å¬å™¨
             // æ³¨æ„: drawBoard() çš„é€»è¾‘ä¼šå¤„ç†åªåœ¨é€‚å½“æ—¶å€™æ·»åŠ ç›‘å¬å™¨
        }

        // å¯ç”¨æ£‹ç›˜äº¤äº’
        function enableBoardInteraction() {
            // ä»…å½“è½®åˆ°äººç±»ç©å®¶ä¸”æ¸¸æˆæœªç»“æŸæ—¶å¯ç”¨
            if (!gameOver && currentPlayer === humanPlayer && !aiIsThinking) {
                boardElement.style.cursor = 'pointer'; // ä¸ºå¯ç‚¹å‡»å•å…ƒæ ¼é‡ç½®å…‰æ ‡
                // é€šè¿‡é‡æ–°ç»˜åˆ¶æ¥æ·»åŠ ç‚¹å‡»ç›‘å¬å™¨ (drawBoard å¤„ç†å‘ç©ºæ ¼å­æ·»åŠ ç›‘å¬å™¨)
            } else {
                 boardElement.style.cursor = 'not-allowed'; // å¦åˆ™è®¾ç½®ä¸ºä¸å…è®¸
            }
        }

        // ç¦ç”¨æ¸¸æˆæ§åˆ¶æŒ‰é’® (æ–°æ¸¸æˆ, AI å…ˆè¡Œ)
        function disableGameButtons() {
            newGameBtn.disabled = true;
            aiFirstBtn.disabled = true;
        }

        // å¯ç”¨æ¸¸æˆæ§åˆ¶æŒ‰é’®
        function enableGameButtons() {
            // ä»…å½“ AI æ²¡æœ‰åœ¨æ´»åŠ¨æ—¶å¯ç”¨
             if (!aiIsThinking) {
                 newGameBtn.disabled = false;
                 aiFirstBtn.disabled = false;
             }
        }

        // æ ¹æ®æ¸¸æˆçŠ¶æ€é›†ä¸­æ›´æ–°æ‰€æœ‰æ§ä»¶çŠ¶æ€çš„å‡½æ•°
        function updateControlStates() {
            const isHumanTurn = !gameOver && currentPlayer === humanPlayer && !aiIsThinking; // æ˜¯å¦è½®åˆ°äººç±»
            const canRetry = aiCanRetry && !gameOver && !aiIsThinking; // æ˜¯å¦å¯ä»¥é‡è¯• (å¿…é¡»æ ‡å¿—ä¸º true ä¸”æ¸¸æˆæœªç»“æŸ AI æœªæ€è€ƒ)

            // æ£‹ç›˜äº¤äº’
            if (isHumanTurn) {
                enableBoardInteraction();
            } else {
                disableBoardInteraction();
            }

            // æ¸¸æˆæŒ‰é’® (æ–°æ¸¸æˆ / AI å…ˆè¡Œ)
            if (aiIsThinking || gameOver) { // å¦‚æœ AI æ€è€ƒä¸­æˆ–æ¸¸æˆç»“æŸï¼Œåˆ™ç¦ç”¨
                 disableGameButtons();
            } else { // ä»…å½“æ¸¸æˆç©ºé—²æ—¶å¯ç”¨ (ç©å®¶å›åˆæˆ–å‡†å¤‡é‡è¯•)
                 enableGameButtons();
            }

            // AI é‡è¯•æŒ‰é’®
            aiRetryBtn.disabled = !canRetry; // æ ¹æ® canRetry çŠ¶æ€è®¾ç½®

            // å¦‚æœéœ€è¦ï¼Œè®°å½•çŠ¶æ€ä»¥ä¾›è°ƒè¯•
            // console.log(`updateControlStates: gameOver=${gameOver}, currentPlayer=${currentPlayer}, aiIsThinking=${aiIsThinking}, aiCanRetry=${aiCanRetry} => isHumanTurn=${isHumanTurn}, canRetry=${canRetry}, retryBtnDisabled=${aiRetryBtn.disabled}`);
        }


        // --- AI é€»è¾‘ ---
        // è§¦å‘ AI è¡ŒåŠ¨
        async function triggerAIMove() {
            // åœ¨ AI å°è¯•å¼€å§‹æ—¶ç¡®ä¿æ ‡å¿—è®¾ç½®æ­£ç¡®
            aiIsThinking = true;
            aiCanRetry = false; // æœ€åˆå‡è®¾æœ¬æ¬¡å°è¯•ä¼šæˆåŠŸ
            updateControlStates(); // æ›´æ–° UI (ç¦ç”¨é‡è¯•ç­‰)

            const activeConfig = apiConfigs.find(c => c.name === selectedConfigName); // è·å–å½“å‰æ¿€æ´»çš„ API é…ç½®
            if (!activeConfig || !gameSettings.selectedModel) { // æ£€æŸ¥é…ç½®å’Œæ¨¡å‹æ˜¯å¦æœ‰æ•ˆ
                logMessage("é”™è¯¯ï¼šæœªé€‰æ‹©æœ‰æ•ˆçš„ API é…ç½®æˆ–æ¨¡å‹ã€‚", "error");
                handleInvalidAIMove("é…ç½®é”™è¯¯"); // ä¼ é€’åŸå› ï¼Œå¯ç”¨é‡è¯•
                return;
            }
            // æ£€æŸ¥ URL å’Œ Key æ˜¯å¦å·²å¡«å†™
            if (!activeConfig.url || !activeConfig.key) {
                logMessage("é”™è¯¯ï¼šå½“å‰ API é…ç½®ç¼ºå°‘ URL æˆ– API Keyã€‚", "error");
                handleInvalidAIMove("é…ç½®ä¸å®Œæ•´"); // ä¼ é€’åŸå› ï¼Œå¯ç”¨é‡è¯•
                return;
            }

            logMessage(`å‡†å¤‡å‘ AI (${gameSettings.selectedModel}) å‘é€è¯·æ±‚...`, "api");
            let boardStateRepresentation; // æ£‹ç›˜çŠ¶æ€è¡¨ç¤º (æ–‡æœ¬æˆ–å›¾åƒæç¤º)
            let requestBody; // API è¯·æ±‚ä½“
            const aiPieceSymbol = aiPlayer === 1 ? 'X' : 'O'; // AI æ£‹å­ç¬¦å· ('X' é»‘, 'O' ç™½)
            const humanPieceSymbol = humanPlayer === 1 ? 'X' : 'O'; // äººç±»æ£‹å­ç¬¦å·

            try {
                // 1. å‡†å¤‡è¯·æ±‚ä½“
                let userMessageContent = []; // ç”¨æˆ·æ¶ˆæ¯å†…å®¹æ•°ç»„ (æ”¯æŒå¤šæ¨¡æ€)
                if (gameSettings.useImage) { // å¦‚æœä½¿ç”¨å›¾åƒæ¨¡å¼
                    const imageDataUrl = generateBoardImage(); // ç”Ÿæˆæ£‹ç›˜å›¾åƒçš„ Base64 URL
                    if (!imageDataUrl) {
                         logMessage("é”™è¯¯ï¼šæ— æ³•ç”Ÿæˆæ£‹ç›˜å›¾åƒï¼Œå°†ä½¿ç”¨æ–‡æœ¬æ¨¡å¼ã€‚", "error");
                         // å¦‚æœå›¾åƒç”Ÿæˆå¤±è´¥ï¼Œå›é€€åˆ°æ–‡æœ¬æ¨¡å¼
                         boardStateRepresentation = getBoardStateText(humanPieceSymbol, aiPieceSymbol);
                         userMessageContent.push({ type: "text", text: getAIPrompt(boardStateRepresentation, aiPieceSymbol) });
                    } else {
                         logMessage("æ£‹ç›˜å›¾åƒå·²ç”Ÿæˆ (Base64)ã€‚", "api");
                         boardStateRepresentation = "Board state is in the image"; // å›¾åƒæ¨¡å¼ä¸‹çš„å ä½æ–‡æœ¬
                         userMessageContent.push({ type: "text", text: getAIPrompt(boardStateRepresentation, aiPieceSymbol) });
                         userMessageContent.push({
                             type: "image_url",
                             image_url: { url: imageDataUrl, detail: "low" } // ä½¿ç”¨ä½ç»†èŠ‚å›¾åƒ
                         });
                    }
                } else { // å¦‚æœä½¿ç”¨æ–‡æœ¬æ¨¡å¼
                    boardStateRepresentation = getBoardStateText(humanPieceSymbol, aiPieceSymbol); // è·å–æ£‹ç›˜æ–‡æœ¬è¡¨ç¤º
                    userMessageContent.push({ type: "text", text: getAIPrompt(boardStateRepresentation, aiPieceSymbol) });
                }

                // æ„å»º API è¯·æ±‚ä½“ (éµå¾ª OpenAI Chat Completions æ ¼å¼)
                requestBody = {
                    model: gameSettings.selectedModel,
                    messages: [
                        { role: "system", content: getSystemPrompt(aiPieceSymbol) }, // ç³»ç»Ÿæç¤º
                        { role: "user", content: userMessageContent } // ç”¨æˆ·æ¶ˆæ¯ (å¯èƒ½åŒ…å«æ–‡æœ¬å’Œå›¾åƒ)
                    ],
                    temperature: gameSettings.temperature,
                    max_tokens: gameSettings.maxTokens,
                };

                // 2. è°ƒç”¨ AI (åŒ…å«é’ˆå¯¹ API é”™è¯¯çš„å†…éƒ¨é‡è¯•é€»è¾‘)
                // å¦‚æœ callAIWithRetry åœ¨æ‰€æœ‰å°è¯•åå¤±è´¥ï¼Œå®ƒä¼šæŠ›å‡ºé”™è¯¯ï¼Œåœ¨ä¸‹é¢çš„ catch å—ä¸­æ•è·
                const aiResponse = await callAIWithRetry(activeConfig.url, activeConfig.key, requestBody);

                // 3. å¤„ç†æˆåŠŸçš„ API å“åº”
                if (!aiResponse || !aiResponse.choices || aiResponse.choices.length === 0 || !aiResponse.choices[0].message || !aiResponse.choices[0].message.content) {
                     logMessage("é”™è¯¯ï¼šAI è¿”å›äº†æ— æ•ˆæˆ–ç©ºçš„å›å¤ç»“æ„ã€‚", "error");
                     handleInvalidAIMove("å›å¤æ— æ•ˆ"); // å¯ç”¨é‡è¯•
                     return; // åœæ­¢å¤„ç†
                }

                const aiRawText = aiResponse.choices[0].message.content; // è·å– AI å›å¤çš„åŸå§‹æ–‡æœ¬
                logMessage(`AI åŸå§‹å›å¤: \n${aiRawText}`, "ai-resp", true); // è®°å½•åŸå§‹å›å¤ï¼Œæ ‡è®°ä¸º raw AI response

                // 4. è§£æ AI çš„ç§»åŠ¨æŒ‡ä»¤
                const move = parseAIMove(aiRawText); // ä»å›å¤æ–‡æœ¬ä¸­è§£æåæ ‡
                if (!move) { // å¦‚æœè§£æå¤±è´¥
                    logMessage("é”™è¯¯ï¼šæ— æ³•ä» AI å›å¤ä¸­è§£æå‡ºæœ‰æ•ˆçš„è½å­ä½ç½®ã€‚", "error");
                    handleInvalidAIMove("è§£æå¤±è´¥"); // å¯ç”¨é‡è¯•
                    return; // åœæ­¢å¤„ç†
                }

                // 5. éªŒè¯ç§»åŠ¨æ˜¯å¦æœ‰æ•ˆ
                const [row, col] = move; // è·å–è§£æå‡ºçš„è¡Œåˆ—å·
                if (row < 0 || row >= BOARD_SIZE || col < 0 || col >= BOARD_SIZE || board[row][col] !== 0) { // æ£€æŸ¥åæ ‡æ˜¯å¦è¶Šç•Œæˆ–ä½ç½®å·²è¢«å ç”¨
                    logMessage(`é”™è¯¯ï¼šAI è¿”å›äº†æ— æ•ˆæˆ–å·²å ç”¨çš„ä½ç½® [${row}, ${col}]ã€‚`, "error");
                    handleInvalidAIMove("æ— æ•ˆè½å­"); // å¯ç”¨é‡è¯•
                    return; // åœæ­¢å¤„ç†
                }

                // 6. æ”¾ç½®æ£‹å­ (æˆåŠŸ!)
                // å¦‚æœä»£ç æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ç§»åŠ¨æ˜¯æœ‰æ•ˆçš„
                aiIsThinking = false; // AI æˆåŠŸå®Œæˆæ€è€ƒ
                // aiCanRetry ä¿æŒ false (åœ¨å‡½æ•°å¼€å§‹æ—¶å·²é‡ç½®)
                placePiece(row, col, aiPlayer); // æ”¾ç½® AI æ£‹å­ (æ­¤å‡½æ•°ä¼šå¤„ç†åˆ‡æ¢å›ç©å®¶å¹¶æ›´æ–°æ§ä»¶)

            } catch (error) { // æ•è·é”™è¯¯
                // è¿™ä¸ª catch å—å¤„ç†:
                // - æ¥è‡ª callAIWithRetry çš„é”™è¯¯ (ä¾‹å¦‚ï¼ŒAPI è°ƒç”¨è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°)
                // - è¯·æ±‚ä½“ç”Ÿæˆ / å›¾åƒç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯
                logMessage(`AI å¤„ç†å¤±è´¥: ${error.message}`, "error");
                handleInvalidAIMove("è¯·æ±‚é”™è¯¯"); // å¯ç”¨é‡è¯•
            } finally {
                 // ç¡®ä¿å¦‚æœåœ¨è°ƒç”¨ placePiece ä¹‹å‰å‘ç”Ÿé”™è¯¯æˆ–è°ƒç”¨äº† handleInvalidAIMoveï¼Œ
                 // åˆ™é‡ç½®æ€è€ƒæ ‡å¿—ã€‚handleInvalidAIMove ä¹Ÿä¼šè®¾ç½®å®ƒã€‚
                 if (aiIsThinking) { // åªæœ‰åœ¨æœªè°ƒç”¨ handleInvalidAIMove ä½†å‘ç”Ÿé”™è¯¯æ—¶æ‰åº”ä¸º true
                     aiIsThinking = false;
                     // å¦‚æœæœªè°ƒç”¨ handleInvalidAIMoveï¼Œæ„å‘³ç€æˆ‘ä»¬ä¸æ‰“ç®—å¯ç”¨é‡è¯•ã€‚
                     // ç„¶è€Œï¼Œåˆ°è¾¾è¿™é‡Œé€šå¸¸æ„å‘³ç€æ„å¤–çš„é”™è¯¯çŠ¶æ€ã€‚
                     // ä¹Ÿè®¸æ›´å®‰å…¨çš„åšæ³•æ˜¯å°†æ§åˆ¶æƒäº¤è¿˜ç»™ç©å®¶è€Œä¸è¿›è¡Œé‡è¯•ï¼Ÿ
                     // ç›®å‰ï¼ŒhandleInvalidAIMove æ¶µç›–äº†é¢„æœŸçš„é‡è¯•åœºæ™¯ã€‚
                     updateControlStates(); // æ›´æ–° UI ä»¥åæ˜ æ€è€ƒåœæ­¢
                 }
                 // å¦‚æœ placePiece æˆåŠŸè°ƒç”¨ï¼ŒaiIsThinking å·²ä¸º falseï¼Œ
                 // å¹¶ä¸”æ§åˆ¶æƒå·²åˆ‡æ¢ç»™ç©å®¶ï¼Œæ›´æ–°äº†æ§ä»¶ã€‚
                 // å¦‚æœ handleInvalidAIMove è¢«è°ƒç”¨ï¼Œå®ƒä¼šå°† aiIsThinking è®¾ç½®ä¸º false å¹¶æ›´æ–°æ§ä»¶ã€‚
            }
        }

        // å¤„ç†æ‰€æœ‰ AI æœªèƒ½åšå‡ºæœ‰æ•ˆç§»åŠ¨çš„æƒ…å†µçš„ä¸­å¤®å¤„ç†å™¨ã€‚
        // æ­¤å‡½æ•°å¯ç”¨ "AI é‡è¯•" æŒ‰é’®ã€‚
        function handleInvalidAIMove(reason) {
            const currentPieceColor = humanPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹'; // ç©å®¶çš„æ£‹å­é¢œè‰²
            updateStatus(`AIæœªèƒ½ä¸‹æ£‹ (${reason})ã€‚è½®åˆ°ä½ äº† (${currentPieceColor})ã€‚å¯å°è¯•[AI é‡è¯•]`);
            logMessage(`AIæœªèƒ½æä¾›æœ‰æ•ˆè½å­ (${reason})ã€‚ç©å®¶å¯ç»§ç»­æˆ–ç‚¹[AI é‡è¯•]ã€‚`, "warning");

            aiIsThinking = false; // AI åœæ­¢æ€è€ƒ (ç”±äºå¤±è´¥)
            aiCanRetry = true; // *** è®¾ç½®æ ‡å¿—ä»¥å…è®¸é‡è¯• ***
            currentPlayer = humanPlayer; // å°†å›åˆäº¤è¿˜ç»™ç©å®¶

            // æ›´æ–°æ§ä»¶ä»¥åæ˜ æ–°çŠ¶æ€ (å¯ç”¨æ£‹ç›˜ï¼Œå¯ç”¨é‡è¯•æŒ‰é’®)
            updateControlStates();
            // é‡æ–°ç»˜åˆ¶æ£‹ç›˜ä»¥ç¡®ä¿ä¸ºç©å®¶çš„å›åˆæ­£ç¡®è®¾ç½®ç‚¹å‡»ç›‘å¬å™¨
            drawBoard();
        }

        // è·å–ç³»ç»Ÿæç¤º (è‹±æ–‡)
        function getSystemPrompt(aiPieceSymbol) {
            const humanPieceSymbol = aiPieceSymbol === 'X' ? 'O' : 'X';
            // æ·»åŠ åæ ‡ç³»è§£é‡Š - ä¸è§†è§‰/å†…éƒ¨è¡¨ç¤ºä¸€è‡´
            return `You are a Gomoku (Five in a Row) AI assistant.
Board size: ${BOARD_SIZE}x${BOARD_SIZE}.
Coordinate system: Row (0 to ${BOARD_SIZE - 1}, top to bottom), Column (0 to ${BOARD_SIZE - 1}, left to right). The board display uses letters A-O for columns (A=0, B=1, ..., O=14) and numbers 0-14 for rows.
Your pieces: '${aiPieceSymbol}' (${aiPieceSymbol === 'X' ? 'Black' : 'White'}).
Opponent's pieces: '${humanPieceSymbol}' (${humanPieceSymbol === 'X' ? 'Black' : 'White'}).
Rules: The first player to get five or more of their pieces in a row (horizontally, vertically, or diagonally) wins.
Task: Analyze the board state (text or image) and choose the best empty cell to place your piece. Consider both offense and defense.
Output format: Your response MUST end with **only** your move decision in the following format: ${gameSettings.moveWrapper.replace('[row]', 'row_number').replace('[col]', 'column_number')}. The row and column numbers MUST be integers between 0 and ${BOARD_SIZE - 1}.
Example: If you decide to play at row 7, column 8 (displayed as I7 on the board), your response must end with: ${gameSettings.moveWrapper.replace('[row]', '7').replace('[col]', '8')}
**Absolutely do not** add any other text, explanation, or punctuation after the ${gameSettings.moveWrapper} tag.`;
        }

        // è·å–ç»™ AI çš„ç”¨æˆ·æç¤º (è‹±æ–‡)
        function getAIPrompt(boardStateText, aiPieceSymbol) {
             let prompt = `This is the current ${BOARD_SIZE}x${BOARD_SIZE} board state.\n`;
             // æé†’ AI å®ƒåº”è¯¥ç”¨äºè¾“å‡ºçš„åæ ‡ç³»
             prompt += `Coordinate system: Row 0-${BOARD_SIZE - 1} (top to bottom), Column 0-${BOARD_SIZE - 1} (left to right).\n`;
             if (!gameSettings.useImage) { // å¦‚æœæ˜¯æ–‡æœ¬æ¨¡å¼
                 prompt += "Board representation: '.'=empty, 'X'=Black, 'O'=White\n";
                 prompt += boardStateText + "\n";
             } else { // å¦‚æœæ˜¯å›¾åƒæ¨¡å¼
                 prompt += "(Board state is in the provided image, which includes row/column labels A-O and 0-14)\n";
             }
             prompt += `You are playing as '${aiPieceSymbol}' (${aiPieceSymbol === 'X' ? 'Black' : 'White'}). It's your turn to move.\n`;
             prompt += `Analyze the board and decide your best move (place one piece on an empty cell).\n`;
             prompt += `Strictly follow the output format requirement. Tell me your chosen move (using 0-${BOARD_SIZE - 1} numbers for both row and column) at the **very end** of your response using this format: ${gameSettings.moveWrapper}`;
             return prompt;
        }

        // ç”Ÿæˆå¸¦æœ‰ A-O / 0-14 æ ‡ç­¾çš„æ–‡æœ¬è¡¨ç¤ºï¼Œä¸è§†è§‰æ£‹ç›˜ä¸€è‡´
        function getBoardStateText(humanSymbol, aiSymbol) {
            let text = "   "; // åˆ—æ ‡ç­¾çš„å¡«å……
            for (let c = 0; c < BOARD_SIZE; c++) {
                 text += String.fromCharCode(65 + c) + " "; // åˆ—æ ‡ç­¾ A-O
            }
            text += "\n";
            for (let r = 0; r < BOARD_SIZE; r++) {
                text += r.toString().padStart(2, ' ') + " "; // è¡Œæ ‡ç­¾ 0-14 (å·¦ä¾§è¡¥é½ç©ºæ ¼)
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] === 0) text += "."; // ç©ºä½
                    // ä½¿ç”¨ç©å®¶åˆ†é… (1=é»‘, 2=ç™½) æ¥å†³å®šç¬¦å·
                    else if (board[r][c] === humanPlayer) text += humanSymbol; // äººç±»ç©å®¶æ£‹å­
                    else text += aiSymbol; // AI ç©å®¶æ£‹å­
                    text += " "; // æ£‹å­é—´ç©ºæ ¼
                }
                text += "\n"; // æ¯è¡Œç»“æŸåæ¢è¡Œ
            }
            return text.trim(); // ç§»é™¤æœ«å°¾å¤šä½™çš„ç©ºç™½
        }

        // ç”Ÿæˆå¸¦æœ‰ A-O / 0-14 æ ‡ç­¾ç»˜åˆ¶åœ¨å…¶ä¸Šçš„å›¾åƒ
        function generateBoardImage() {
            const cellSize = 30; // å›ºå®šå¤§å°ä»¥ä¿è¯å›¾åƒç”Ÿæˆä¸€è‡´æ€§
            const pieceRadius = cellSize * 0.4; // æ£‹å­åŠå¾„
            const labelSize = 20; // å›¾åƒä¸­æ ‡ç­¾çš„ç©ºé—´
            const boardDimension = BOARD_SIZE * cellSize; // æ£‹ç›˜åŒºåŸŸå°ºå¯¸
            const totalWidth = boardDimension + labelSize; // ç”»å¸ƒæ€»å®½åº¦
            const totalHeight = boardDimension + labelSize; // ç”»å¸ƒæ€»é«˜åº¦
            const boardOffsetX = labelSize; // æ£‹ç›˜åŒºåŸŸ X è½´åç§»é‡
            const boardOffsetY = labelSize; // æ£‹ç›˜åŒºåŸŸ Y è½´åç§»é‡

            boardCanvas.width = totalWidth; // è®¾ç½®ç”»å¸ƒå®½åº¦
            boardCanvas.height = totalHeight; // è®¾ç½®ç”»å¸ƒé«˜åº¦

            // èƒŒæ™¯
            ctx.fillStyle = '#f0f2f5'; // åŒ¹é…é¡µé¢èƒŒæ™¯è‰²
            ctx.fillRect(0, 0, totalWidth, totalHeight);

            // æ£‹ç›˜èƒŒæ™¯
            ctx.fillStyle = '#F5DEB3'; // æœ¨è‰²èƒŒæ™¯
            ctx.fillRect(boardOffsetX, boardOffsetY, boardDimension, boardDimension);

            // ç½‘æ ¼çº¿
            ctx.strokeStyle = '#aaa'; // çº¿æ¡é¢œè‰²
            ctx.lineWidth = 1; // çº¿æ¡å®½åº¦
            const lineStart = cellSize / 2; // ç¬¬ä¸€ä¸ªå•å…ƒæ ¼çš„ä¸­å¿ƒ
            for (let i = 0; i < BOARD_SIZE; i++) {
                // å‚ç›´çº¿
                ctx.beginPath();
                ctx.moveTo(boardOffsetX + lineStart + i * cellSize, boardOffsetY + lineStart);
                ctx.lineTo(boardOffsetX + lineStart + i * cellSize, boardOffsetY + boardDimension - lineStart);
                ctx.stroke();
                // æ°´å¹³çº¿
                ctx.beginPath();
                ctx.moveTo(boardOffsetX + lineStart, boardOffsetY + lineStart + i * cellSize);
                ctx.lineTo(boardOffsetX + boardDimension - lineStart, boardOffsetY + lineStart + i * cellSize);
                ctx.stroke();
            }

            // æ˜Ÿä½ (å¤©å…ƒåŠå…¶ä»– 15x15 æ£‹ç›˜çš„æ˜Ÿä½)
             const starPoints = [ [3, 3], [3, 11], [11, 3], [11, 11], [7, 7] ]; // æ˜Ÿä½åæ ‡ (row, col)
             ctx.fillStyle = '#555'; // æ·±è‰²ç‚¹
             starPoints.forEach(([r, c]) => {
                 if (r < BOARD_SIZE && c < BOARD_SIZE) { // ç¡®ä¿åæ ‡åœ¨æ£‹ç›˜å†…
                     ctx.beginPath();
                     // è®¡ç®—æ˜Ÿä½ä¸­å¿ƒç‚¹åæ ‡
                     ctx.arc(boardOffsetX + lineStart + c * cellSize, boardOffsetY + lineStart + r * cellSize, cellSize * 0.1, 0, Math.PI * 2);
                     ctx.fill();
                 }
             });

            // æ ‡ç­¾ (åœ¨å›¾åƒä¸Šç»˜åˆ¶ - A-O / 0-14)
            ctx.fillStyle = '#333'; // æ ‡ç­¾é¢œè‰²
            ctx.font = `${labelSize * 0.6}px sans-serif`; // æ ‡ç­¾å­—ä½“å¤§å°
            ctx.textAlign = 'center'; // æ°´å¹³å±…ä¸­
            ctx.textBaseline = 'middle'; // å‚ç›´å±…ä¸­
            // åˆ—æ ‡ç­¾ (A-O)
            for (let c = 0; c < BOARD_SIZE; c++) {
                ctx.fillText(String.fromCharCode(65 + c), boardOffsetX + lineStart + c * cellSize, boardOffsetY - labelSize / 2);
            }
            // è¡Œæ ‡ç­¾ (0-14)
            ctx.textAlign = 'right'; // è¡Œå·å³å¯¹é½
            ctx.textBaseline = 'middle';
            for (let r = 0; r < BOARD_SIZE; r++) {
                ctx.fillText(r, boardOffsetX - labelSize / 3, boardOffsetY + lineStart + r * cellSize);
            }

            // æ£‹å­
            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    if (board[r][c] !== 0) { // å¦‚æœè¯¥ä½ç½®æœ‰æ£‹å­
                        const centerX = boardOffsetX + lineStart + c * cellSize; // æ£‹å­ä¸­å¿ƒ X åæ ‡
                        const centerY = boardOffsetY + lineStart + r * cellSize; // æ£‹å­ä¸­å¿ƒ Y åæ ‡
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, pieceRadius, 0, Math.PI * 2); // ç»˜åˆ¶åœ†å½¢

                        const isBlack = board[r][c] === 1; // 1 ä»£è¡¨é»‘æ£‹
                        // è®¡ç®—æ¸å˜ä¸­å¿ƒç‚¹ï¼Œæ¨¡æ‹Ÿå…‰ç…§æ•ˆæœ
                        const gradX = isBlack ? centerX - pieceRadius * 0.3 : centerX + pieceRadius * 0.3;
                        const gradY = isBlack ? centerY - pieceRadius * 0.3 : centerY + pieceRadius * 0.3;
                        const gradColor0 = isBlack ? '#555' : '#fff'; // æ¸å˜èµ·å§‹è‰² (é«˜å…‰)
                        const gradColor1 = isBlack ? '#000' : '#ccc'; // æ¸å˜ç»“æŸè‰² (ä¸»ä½“)

                        // åˆ›å»ºæ”¾å°„çŠ¶æ¸å˜
                        const gradient = ctx.createRadialGradient(gradX, gradY, pieceRadius * 0.1, centerX, centerY, pieceRadius);
                        gradient.addColorStop(0, gradColor0);
                        gradient.addColorStop(1, gradColor1);

                        ctx.fillStyle = gradient; // åº”ç”¨æ¸å˜å¡«å……
                        ctx.fill();

                        // æ·»åŠ ç»†å¾®è¾¹æ¡†ä½¿æ£‹å­æ›´æ¸…æ™°
                        ctx.strokeStyle = isBlack ? '#222' : '#bbb'; // è¾¹æ¡†é¢œè‰²
                        ctx.lineWidth = 0.5; // è¾¹æ¡†å®½åº¦
                        ctx.stroke();
                    }
                }
            }
            try { return boardCanvas.toDataURL('image/png'); } // å°è¯•å°† Canvas è½¬æ¢ä¸º PNG Data URL
            catch (e) { console.error("Canvas toDataURL error:", e); logMessage("ç”Ÿæˆæ£‹ç›˜å›¾åƒå¤±è´¥ (Canvas Error)", "error"); return null; } // æ•è·å¹¶è®°å½•é”™è¯¯
        }

        // å¤„ç† API è°ƒç”¨ï¼Œä»…å¯¹ç½‘ç»œ/æœåŠ¡å™¨é”™è¯¯è¿›è¡Œé‡è¯•
        async function callAIWithRetry(apiUrl, apiKey, requestBody, attempt = 1) {
            logMessage(`[API] ç¬¬ ${attempt} æ¬¡å°è¯•è°ƒç”¨ ${requestBody.model}...`, "api");
            const currentPieceColor = aiPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹';
            // ä»…å½“ AI ä»æ ‡è®°ä¸ºæ€è€ƒä¸­æ—¶æ›´æ–°çŠ¶æ€ (å¯èƒ½å·²è¢«æ–°æ¸¸æˆå–æ¶ˆ)
            if (aiIsThinking) {
                updateStatus(`AI (${currentPieceColor}) æ€è€ƒä¸­... (API å°è¯• ${attempt}/${gameSettings.retryAttempts})`);
            }

            try {
                const response = await fetch(apiUrl, { // å‘èµ· fetch è¯·æ±‚
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, // è®¾ç½®è¯·æ±‚å¤´
                    body: JSON.stringify(requestBody) // å‘é€ JSON æ ¼å¼çš„è¯·æ±‚ä½“
                });

                if (!response.ok) { // å¦‚æœå“åº”çŠ¶æ€ç ä¸æ˜¯ 2xx
                    let errorBodyText = await response.text(); // å…ˆè¯»å–æ–‡æœ¬æ ¼å¼çš„é”™è¯¯å“åº”ä½“
                    let errorJson = null;
                    try { errorJson = JSON.parse(errorBodyText); } catch (e) { /* å¦‚æœä¸æ˜¯ JSON åˆ™å¿½ç•¥ */ }
                    // æ„å»ºè¯¦ç»†çš„é”™è¯¯æ¶ˆæ¯
                    const errorMsg = `API è¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. ${errorJson ? `è¯¦æƒ…: ${JSON.stringify(errorJson)}` : `å“åº”: ${errorBodyText}`}`;
                    throw new Error(errorMsg); // æŠ›å‡ºé”™è¯¯ä»¥è§¦å‘é‡è¯•æˆ–æœ€ç»ˆå¤±è´¥
                }

                const data = await response.json(); // è§£ææˆåŠŸçš„ JSON å“åº”
                logMessage("[API] è¯·æ±‚æˆåŠŸï¼", "success");
                return data; // è¿”å›æˆåŠŸçš„æ•°æ®

            } catch (error) { // æ•è· fetch æˆ–å“åº”å¤„ç†ä¸­çš„é”™è¯¯
                logMessage(`[API] ç¬¬ ${attempt} æ¬¡è¯·æ±‚å¤±è´¥: ${error.message}`, "error");
                if (attempt < gameSettings.retryAttempts) { // å¦‚æœè¿˜æ²¡è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
                    logMessage(`å°†åœ¨ ${gameSettings.retryDelay / 1000} ç§’åé‡è¯•...`, "warning");
                    await new Promise(resolve => setTimeout(resolve, gameSettings.retryDelay)); // ç­‰å¾…æŒ‡å®šå»¶è¿Ÿ
                    // æ£€æŸ¥ç­‰å¾…æœŸé—´æ¸¸æˆçŠ¶æ€æ˜¯å¦å·²æ”¹å˜ (ä¾‹å¦‚ï¼Œå¼€å§‹äº†æ–°æ¸¸æˆ)
                    if (!aiIsThinking || gameOver) {
                        logMessage("[API] é‡è¯•è¢«å–æ¶ˆ (æ¸¸æˆçŠ¶æ€å·²æ”¹å˜)ã€‚", "warning");
                        throw new Error("AI API é‡è¯•è¢«å–æ¶ˆ"); // æŠ›å‡ºç‰¹å®šé”™è¯¯ä»¥åœæ­¢é‡è¯•
                    }
                    // é€’å½’è°ƒç”¨è¿›è¡Œé‡è¯•
                    return callAIWithRetry(apiUrl, apiKey, requestBody, attempt + 1);
                } else { // å¦‚æœå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°
                    logMessage("[API] è¯·æ±‚è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ”¾å¼ƒã€‚", "error");
                    // åœ¨æœ€å¤§é‡è¯•æ¬¡æ•°åé‡æ–°æŠ›å‡ºæœ€ç»ˆé”™è¯¯ï¼Œå°†è¢« triggerAIMove æ•è·
                    throw new Error(`API è¯·æ±‚å¤±è´¥ (å·²è¾¾æœ€å¤§é‡è¯•æ¬¡æ•°): ${error.message}`);
                }
            }
        }

        // è§£æ AI å“åº”ï¼ŒæœŸæœ›æ ¼å¼ä¸ºåŸºäº moveWrapper çš„ "[row],[col]"
        function parseAIMove(responseText) {
            // å¯¹ç”¨æˆ·å®šä¹‰çš„åŒ…è£…å™¨ä¸­çš„ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ä»¥ç”¨äºæ­£åˆ™è¡¨è¾¾å¼
            const escapedWrapper = gameSettings.moveWrapper
                .replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&') // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
                .replace('\\\[row\\\]', '\\s*(\\d+)\\s*')   // åŒ¹é…è¡Œå· (0-14, å…è®¸å‰åæœ‰ç©ºæ ¼)
                .replace('\\\[col\\\]', '\\s*(\\d+)\\s*');  // åŒ¹é…åˆ—å· (0-14, å…è®¸å‰åæœ‰ç©ºæ ¼)

            // æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºä¸¥æ ¼åœ¨å­—ç¬¦ä¸²æœ«å°¾æŸ¥æ‰¾åŒ…è£…å™¨ (å¯èƒ½åœ¨ç©ºç™½ä¹‹å)
            // 'm' æ ‡å¿—å…è®¸ '$' åŒ¹é…è¡Œå°¾ (å¦‚æœ responseText æœ‰å¤šè¡Œ)
            // 'i' æ ‡å¿—ä½¿åŒ¹é…ä¸åŒºåˆ†å¤§å°å†™ (è™½ç„¶åŒ…è£…å™¨é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œä½†å¢åŠ é²æ£’æ€§)
            const regex = new RegExp(escapedWrapper + '\\s*$', 'im');
            const match = responseText.match(regex); // å°è¯•åŒ¹é…

            if (match && match[1] && match[2]) { // å¦‚æœåŒ¹é…æˆåŠŸä¸”æ•è·åˆ°ä¸¤ä¸ªæ•°å­—
                const row = parseInt(match[1]);
                const col = parseInt(match[2]);
                // åŸºæœ¬çš„èŒƒå›´å¥å…¨æ€§æ£€æŸ¥ (æ›´å…·ä½“çš„æ£€æŸ¥åœ¨ triggerAIMove ä¸­å®Œæˆ)
                if (row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE) {
                    logMessage(`[è§£æ] æˆåŠŸè§£æ AI è½å­: [${row}, ${col}] (ä½¿ç”¨æ ¼å¼: ${gameSettings.moveWrapper})`, "success");
                    return [row, col]; // è¿”å›è§£æå‡ºçš„åæ ‡æ•°ç»„
                } else {
                     logMessage(`[è§£æ] æ‰¾åˆ°æ ¼å¼ ${gameSettings.moveWrapper} ä½†åæ ‡ [${row}, ${col}] è¶…å‡ºèŒƒå›´ (0-${BOARD_SIZE-1})ã€‚`, "error");
                     return null; // åæ ‡èŒƒå›´æ— æ•ˆ
                }
            } else {
                // å¤‡ç”¨æ–¹æ¡ˆ: å°è¯•åœ¨æœ«å°¾æŸ¥æ‰¾ç®€å•çš„ [row, col] æˆ– (row, col) æ ¼å¼
                const fallbackRegex = /[\[\(]\s*(\d+)\s*,\s*(\d+)\s*[\]\)]\s*$/m;
                const fallbackMatch = responseText.match(fallbackRegex);
                 if (fallbackMatch && fallbackMatch[1] && fallbackMatch[2]) { // å¦‚æœå¤‡ç”¨åŒ¹é…æˆåŠŸ
                     const row = parseInt(fallbackMatch[1]);
                     const col = parseInt(fallbackMatch[2]);
                     if (row >= 0 && row < BOARD_SIZE && col >= 0 && col < BOARD_SIZE) { // æ£€æŸ¥èŒƒå›´
                         logMessage(`[è§£æ] ä½¿ç”¨å¤‡ç”¨æ ¼å¼ [row,col] æˆ– (row,col) è§£æ AI è½å­: [${row}, ${col}]`, "warning");
                         return [row, col]; // è¿”å›å¤‡ç”¨è§£æç»“æœ
                     } else {
                         logMessage(`[è§£æ] æ‰¾åˆ°å¤‡ç”¨æ ¼å¼ä½†åæ ‡ [${row}, ${col}] è¶…å‡ºèŒƒå›´ (0-${BOARD_SIZE-1})ã€‚`, "error");
                         return null; // å¤‡ç”¨æ ¼å¼åæ ‡èŒƒå›´æ— æ•ˆ
                     }
                 }
                 // å¦‚æœä¸»è¦æ ¼å¼å’Œå¤‡ç”¨æ ¼å¼éƒ½è§£æå¤±è´¥
                 logMessage(`[è§£æ] æ— æ³•ä½¿ç”¨æ ¼å¼ "${gameSettings.moveWrapper}" æˆ–å¤‡ç”¨æ ¼å¼ "[row,col]"/"(row,col)" åœ¨å›å¤æœ«å°¾è§£æå‡ºæœ‰æ•ˆçš„ 0-${BOARD_SIZE-1} åæ ‡ã€‚åŸå§‹å›å¤è§æ—¥å¿—ã€‚`, "error");
                return null; // è§£æå®Œå…¨å¤±è´¥
            }
        }

        // --- è®¾ç½®ç®¡ç† ---

        // åŠ è½½è®¾ç½® (API é…ç½®å’Œæ¸¸æˆè®¾ç½®)
        function loadSettings() {
            // åŠ è½½ API é…ç½®
            const storedConfigs = localStorage.getItem('gomoku_apiConfigs_v1'); // ä½¿ç”¨ v1 key
            if (storedConfigs) {
                try { apiConfigs = JSON.parse(storedConfigs); if (!Array.isArray(apiConfigs)) apiConfigs = []; }
                catch (e) { console.error("è§£æå­˜å‚¨çš„ API é…ç½®æ—¶å‡ºé”™:", e); apiConfigs = []; }
            }
            if (apiConfigs.length === 0) {
                // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„é…ç½®ï¼Œæ·»åŠ ä¸€ä¸ªç©ºçš„å ä½ç¬¦ï¼Œæç¤ºç”¨æˆ·å¡«å†™
                apiConfigs.push({ name: "è¯·ç¼–è¾‘æ­¤é…ç½®", url: "", key: "", models: [] }); // é»˜è®¤ URL/Key ä¸ºç©ºï¼Œæ¨¡å‹åˆ—è¡¨ä¸ºç©º
                // ä¸å†è‡ªåŠ¨ä¿å­˜è¿™ä¸ªç©ºçš„å ä½ç¬¦ï¼Œè®©ç”¨æˆ·æ˜ç¡®æ·»åŠ å’Œä¿å­˜
                // localStorage.setItem('gomoku_apiConfigs_v1', JSON.stringify(apiConfigs));
            }

            // åŠ è½½ä¸Šæ¬¡é€‰ä¸­çš„é…ç½®åç§°
            selectedConfigName = localStorage.getItem('gomoku_selectedConfigName_v1') || apiConfigs[0]?.name || ''; // ä½¿ç”¨ v1 key
            // ç¡®ä¿é€‰ä¸­çš„é…ç½®ç¡®å®å­˜åœ¨
            if (!apiConfigs.some(c => c.name === selectedConfigName)) {
                selectedConfigName = apiConfigs[0]?.name || ''; // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
                localStorage.setItem('gomoku_selectedConfigName_v1', selectedConfigName); // æ›´æ–°å­˜å‚¨
            }

            // åŠ è½½æ¸¸æˆè®¾ç½®
            gameSettings.selectedModel = localStorage.getItem('gomoku_selectedModel_v1') || ''; // ä½¿ç”¨ v1 key
            gameSettings.useImage = localStorage.getItem('gomoku_useImage_v1') === 'true'; // ä½¿ç”¨ v1 key
            // ä½¿ç”¨ gameSettings ä¸­çš„é»˜è®¤å€¼ä½œä¸º fallback
            gameSettings.temperature = parseFloat(localStorage.getItem('gomoku_temperature_v1') || gameSettings.temperature); // ä½¿ç”¨ v1 key
            gameSettings.maxTokens = parseInt(localStorage.getItem('gomoku_maxTokens_v1') || gameSettings.maxTokens); // ä½¿ç”¨ v1 key
            gameSettings.moveWrapper = localStorage.getItem('gomoku_moveWrapper_v1') || gameSettings.moveWrapper; // ä½¿ç”¨ v1 key
            gameSettings.showRawResponse = localStorage.getItem('gomoku_showRawResponse_v1') === 'true'; // ä½¿ç”¨ v1 key

            // æ ¹æ®åŠ è½½çš„è®¾ç½®æ›´æ–° UI
            populateApiConfigSelect(); // å¡«å…… API é…ç½®ä¸‹æ‹‰åˆ—è¡¨
            displaySelectedConfig(); // æ˜¾ç¤ºé€‰å®šé…ç½®çš„è¯¦ç»†ä¿¡æ¯å¹¶å¡«å……æ¨¡å‹é€‰æ‹©åˆ—è¡¨
            updateGameSettingsUI(); // è®¾ç½®æ¸¸æˆè®¾ç½® UI å…ƒç´  (æ¸©åº¦ã€Token ç­‰)
            updateLogAreaVisibility(); // è®¾ç½®æ—¥å¿—å¯è§æ€§

            logMessage("è®¾ç½®å·²åŠ è½½ã€‚", "info");
        }

        // ä¿å­˜ API é…ç½®åˆ° localStorage
        function saveApiConfigs() {
             localStorage.setItem('gomoku_apiConfigs_v1', JSON.stringify(apiConfigs)); // ä½¿ç”¨ v1 key
             localStorage.setItem('gomoku_selectedConfigName_v1', selectedConfigName); // ä½¿ç”¨ v1 key
             logMessage("API é…ç½®å·²ä¿å­˜åˆ° localStorageã€‚", "success");
        }

        // ä¿å­˜æ¸¸æˆè®¾ç½®åˆ° localStorage
        function saveGameSettings() {
            // ä» UI è¯»å–è®¾ç½®å€¼
            gameSettings.selectedModel = apiModelSelect.value;
            gameSettings.useImage = useImageCheckbox.checked;
            gameSettings.temperature = parseFloat(temperatureInput.value);
            gameSettings.maxTokens = parseInt(maxTokensInput.value);
            gameSettings.moveWrapper = moveWrapperInput.value.trim(); // å»é™¤å‰åç©ºæ ¼
            gameSettings.showRawResponse = showRawAiResponseCheckbox.checked;

            // éªŒè¯ moveWrapper - å¿…é¡»åŒ…å« '[row]' å’Œ '[col]' å­—é¢é‡
             if (!gameSettings.moveWrapper || !gameSettings.moveWrapper.includes('[row]') || !gameSettings.moveWrapper.includes('[col]')) {
                 alert("é”™è¯¯ï¼šè½å­æ ‡è®°å¿…é¡»åŒ…å« '[row]' å’Œ '[col]' è¿™ä¸¤ä¸ªå ä½ç¬¦ã€‚");
                 logMessage("é”™è¯¯ï¼šè½å­æ ‡è®°æ ¼å¼æ— æ•ˆï¼Œæœªä¿å­˜æ¸¸æˆè®¾ç½®ã€‚", "error");
                 // æ¢å¤ UI åˆ°ä¸Šæ¬¡ä¿å­˜çš„çŠ¶æ€å¯èƒ½æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä»…ä¸ä¿å­˜
                 // updateGameSettingsUI(); // æ¢å¤ UI (å¯é€‰)
                 return; // é˜»æ­¢ä¿å­˜
             }

            // ä¿å­˜åˆ° localStorage (ä½¿ç”¨ v1 key)
            localStorage.setItem('gomoku_selectedModel_v1', gameSettings.selectedModel);
            localStorage.setItem('gomoku_useImage_v1', gameSettings.useImage);
            localStorage.setItem('gomoku_temperature_v1', gameSettings.temperature);
            localStorage.setItem('gomoku_maxTokens_v1', gameSettings.maxTokens);
            localStorage.setItem('gomoku_moveWrapper_v1', gameSettings.moveWrapper);
            localStorage.setItem('gomoku_showRawResponse_v1', gameSettings.showRawResponse);

            updateLogAreaVisibility(); // ç«‹å³æ›´æ–°æ—¥å¿—å¯è§æ€§
            logMessage("æ¸¸æˆè®¾ç½®å·²ä¿å­˜ï¼", "success");
        }

        // --- UI æ›´æ–°å‡½æ•° ---

        // å¡«å…… API é…ç½®é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨
        function populateApiConfigSelect() {
            apiConfigSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            apiConfigs.forEach(config => {
                const option = document.createElement('option');
                option.value = config.name;
                option.textContent = config.name;
                if (config.name === selectedConfigName) {
                    option.selected = true; // é€‰ä¸­å½“å‰é…ç½®
                }
                apiConfigSelect.appendChild(option);
            });
        }

        // æ˜¾ç¤ºå½“å‰é€‰å®š API é…ç½®çš„è¯¦ç»†ä¿¡æ¯
        function displaySelectedConfig() {
            const config = apiConfigs.find(c => c.name === selectedConfigName); // æŸ¥æ‰¾é€‰ä¸­çš„é…ç½®å¯¹è±¡
            if (config) { // å¦‚æœæ‰¾åˆ°é…ç½®
                apiConfigNameInput.value = config.name; // æ˜¾ç¤ºåç§°
                apiUrlInput.value = config.url; // æ˜¾ç¤º URL
                apiKeyInput.value = config.key; // æ˜¾ç¤º Key (å¯†ç æ¡†)
                apiModelsListInput.value = config.models.join(', '); // æ˜¾ç¤ºæ¨¡å‹åˆ—è¡¨ (é€—å·åˆ†éš”)
                populateModelSelect(config.models); // æ ¹æ®æ­¤é…ç½®çš„æ¨¡å‹åˆ—è¡¨å¡«å……æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            } else { // å¦‚æœé€‰ä¸­çš„é…ç½®ä¸å­˜åœ¨ (ä¾‹å¦‚ï¼Œåˆ é™¤å)
                apiConfigNameInput.value = '';
                apiUrlInput.value = '';
                apiKeyInput.value = '';
                apiModelsListInput.value = '';
                populateModelSelect([]); // æ¸…ç©ºæ¨¡å‹åˆ—è¡¨
                if (apiConfigs.length > 0) { // å¦‚æœè¿˜æœ‰å…¶ä»–é…ç½®ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ª
                    selectedConfigName = apiConfigs[0].name;
                    apiConfigSelect.value = selectedConfigName; // æ›´æ–°ä¸‹æ‹‰æ¡†é€‰æ‹©
                    displaySelectedConfig(); // ä½¿ç”¨ç¬¬ä¸€ä¸ªé…ç½®é‡æ–°è¿è¡Œæ­¤å‡½æ•°
                } else {
                    // å¦‚æœè¿ä¸€ä¸ªé…ç½®éƒ½æ²¡æœ‰äº†ï¼Œç¡®ä¿æ¨¡å‹ä¸‹æ‹‰æ¡†æ˜¯ç©ºçš„
                     populateModelSelect([]);
                }
            }
        }

        // å¡«å……æ¸¸æˆè®¾ç½®ä¸­çš„æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨
        function populateModelSelect(models) {
            apiModelSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
            if (!models || models.length === 0) { // å¦‚æœæ²¡æœ‰æ¨¡å‹æˆ–åˆ—è¡¨ä¸ºç©º
                 const option = document.createElement('option');
                 option.value = "";
                 option.textContent = "è¯·å…ˆåœ¨APIé…ç½®ä¸­æ·»åŠ å¹¶ä¿å­˜æ¨¡å‹"; // æç¤ºä¿¡æ¯
                 option.disabled = true; // ç¦ç”¨æ­¤é€‰é¡¹
                 option.selected = true; // é»˜è®¤é€‰ä¸­
                 apiModelSelect.appendChild(option);
                 gameSettings.selectedModel = ''; // æ²¡æœ‰æ¨¡å‹è¢«é€‰ä¸­
                 return;
            }

            let foundSavedModel = false; // æ ‡è®°æ˜¯å¦æ‰¾åˆ°äº†ä¸Šæ¬¡ä¿å­˜çš„æ¨¡å‹
            models.forEach(modelName => { // éå†æ¨¡å‹åç§°åˆ—è¡¨
                if (!modelName) return; // è·³è¿‡ç©ºæ¨¡å‹åç§°
                const option = document.createElement('option');
                option.value = modelName;
                option.textContent = modelName;
                // æ ¹æ®å½“å‰ä¿å­˜çš„æ¸¸æˆè®¾ç½®é€‰æ‹©æ¨¡å‹
                if (modelName === gameSettings.selectedModel) {
                    option.selected = true;
                    foundSavedModel = true; // æ ‡è®°å·²æ‰¾åˆ°
                }
                apiModelSelect.appendChild(option);
            });

             // å¦‚æœä¸Šæ¬¡ä¿å­˜çš„æ¨¡å‹ä¸åœ¨æ­¤é…ç½®çš„åˆ—è¡¨ä¸­ï¼Œæˆ–è€…æ²¡æœ‰ä¿å­˜è¿‡æ¨¡å‹ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„æ¨¡å‹
             if (!foundSavedModel && apiModelSelect.options.length > 0 && apiModelSelect.options[0].value) {
                 apiModelSelect.selectedIndex = 0; // é€‰æ‹©ç¬¬ä¸€ä¸ªé€‰é¡¹
                 gameSettings.selectedModel = apiModelSelect.value; // æ›´æ–°è®¾ç½®çŠ¶æ€ä»¥åŒ¹é… UI
             } else if (apiModelSelect.options.length === 0 || !apiModelSelect.options[0].value) {
                 // æ­¤æƒ…å†µç”±åˆå§‹æ£€æŸ¥å¤„ç†ï¼Œä½†ä½œä¸ºé˜²å¾¡æ€§æªæ–½ï¼š
                 gameSettings.selectedModel = ''; // æ²¡æœ‰å¯ç”¨çš„æ¨¡å‹
             }
             // å¦‚æœ foundSavedModel ä¸º trueï¼Œåˆ™ gameSettings.selectedModel å·²ç»æ˜¯æ­£ç¡®çš„ã€‚
        }

        // æ›´æ–°æ¸¸æˆè®¾ç½®ç›¸å…³çš„ UI å…ƒç´ 
        function updateGameSettingsUI() {
            // æ ¹æ® gameSettings å¯¹è±¡æ›´æ–° UI å…ƒç´ çš„å€¼
            useImageCheckbox.checked = gameSettings.useImage;
            temperatureInput.value = gameSettings.temperature;
            maxTokensInput.value = gameSettings.maxTokens;
            moveWrapperInput.value = gameSettings.moveWrapper;
            showRawAiResponseCheckbox.checked = gameSettings.showRawResponse;

             // ç¡®ä¿åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰ä¸­æ­£ç¡®çš„æ¨¡å‹
             // è¿™å¯èƒ½åœ¨ populateModelSelect ä¹‹åè¿è¡Œï¼Œå› æ­¤éœ€è¦ç¡®ä¿ä¸€è‡´æ€§
             const modelExistsInCurrentList = [...apiModelSelect.options].some(opt => opt.value === gameSettings.selectedModel);

             if (gameSettings.selectedModel && modelExistsInCurrentList) {
                 // å¦‚æœä¿å­˜çš„æ¨¡å‹åœ¨å½“å‰åˆ—è¡¨ä¸­å­˜åœ¨ï¼Œåˆ™é€‰ä¸­å®ƒ
                 apiModelSelect.value = gameSettings.selectedModel;
             } else if (apiModelSelect.options.length > 0 && apiModelSelect.options[0].value) {
                 // å¦‚æœä¿å­˜çš„æ¨¡å‹å¯¹äºå½“å‰é…ç½®æ— æ•ˆ/ç¼ºå¤±ï¼Œåˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•ˆé€‰é¡¹
                 apiModelSelect.selectedIndex = 0;
                 // è®© saveGameSettings å¤„ç†è®¾ç½®çŠ¶æ€çš„æ›´æ–°
                 // gameSettings.selectedModel = apiModelSelect.value;
             } else {
                  // æ²¡æœ‰æœ‰æ•ˆçš„æ¨¡å‹è¢«é€‰ä¸­æˆ–å¯ç”¨
                  // è®© saveGameSettings å¤„ç†è®¾ç½®çŠ¶æ€çš„æ›´æ–°
                  // gameSettings.selectedModel = '';
             }
        }

        // æ›´æ–°æ—¥å¿—åŒºåŸŸ AI åŸå§‹å›å¤çš„å¯è§æ€§
        function updateLogAreaVisibility() {
            if (gameSettings.showRawResponse) { // å¦‚æœè®¾ç½®äº†æ˜¾ç¤ºåŸå§‹å›å¤
                logArea.classList.add('show-raw-ai'); // æ·»åŠ  CSS ç±»ä»¥æ˜¾ç¤º
            } else {
                logArea.classList.remove('show-raw-ai'); // ç§»é™¤ CSS ç±»ä»¥éšè—
            }
        }

        // --- æ—¥å¿—å·¥å…· ---
        // åœ¨æ—¥å¿—åŒºåŸŸæ·»åŠ ä¸€æ¡æ¶ˆæ¯
        function logMessage(message, type = 'info', isRawAI = false) {
            const logEntry = document.createElement('p'); // åˆ›å»º p å…ƒç´ 
            logEntry.classList.add(`log-${type}`); // æ·»åŠ ç±»å‹å¯¹åº”çš„ CSS ç±» (log-info, log-error ç­‰)
            if (isRawAI) { // å¦‚æœæ˜¯åŸå§‹ AI å›å¤
                logEntry.classList.add('log-ai-resp'); // æ·»åŠ ç‰¹å®šç±»ä»¥æ§åˆ¶å¯è§æ€§
            }
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); // è·å–å½“å‰æ—¶é—´
            // ä½¿ç”¨ textContent ä»¥ç¡®ä¿å®‰å…¨ï¼Œé™¤éæ˜ç¡®éœ€è¦ HTML ä¸”å·²è¿›è¡Œæ¸…ç†
            logEntry.textContent = `[${time}] ${message}`; // è®¾ç½®æ–‡æœ¬å†…å®¹
            logArea.appendChild(logEntry); // æ·»åŠ åˆ°æ—¥å¿—åŒºåŸŸ
            logArea.scrollTop = logArea.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        }

        // --- äº‹ä»¶ç›‘å¬å™¨ ---
        newGameBtn.addEventListener('click', () => initGame(false)); // æ–°æ¸¸æˆ (ç©å®¶å…ˆæ‰‹)
        aiFirstBtn.addEventListener('click', () => initGame(true)); // æ–°æ¸¸æˆ (AI å…ˆæ‰‹)
        saveGameSettingsBtn.addEventListener('click', saveGameSettings); // ä¿å­˜æ¸¸æˆè®¾ç½®

        // "æ˜¾ç¤º AI åŸå§‹å›å¤" å¤é€‰æ¡†å˜åŒ–ç›‘å¬
        showRawAiResponseCheckbox.addEventListener('change', () => {
            gameSettings.showRawResponse = showRawAiResponseCheckbox.checked; // æ›´æ–°è®¾ç½®çŠ¶æ€
            localStorage.setItem('gomoku_showRawResponse_v1', gameSettings.showRawResponse); // ç«‹å³ä¿å­˜åˆ° localStorage (ä½¿ç”¨ v1 key)
            updateLogAreaVisibility(); // æ›´æ–°æ—¥å¿—å¯è§æ€§
        });

        // æ¸…é™¤æ—¥å¿—æŒ‰é’®ç›‘å¬
        clearLogBtn.addEventListener('click', () => { // æ·»åŠ 
            logArea.innerHTML = ''; // æ¸…ç©ºæ—¥å¿—åŒºåŸŸå†…å®¹
            logMessage("æ—¥å¿—å·²æ¸…é™¤ã€‚", "info"); // æ·»åŠ ä¸€æ¡æ¸…é™¤æ—¥å¿—çš„æ¶ˆæ¯
        });

        // AI é‡è¯•æŒ‰é’®ç›‘å¬
        aiRetryBtn.addEventListener('click', () => {
            // å†æ¬¡æ£€æŸ¥æ¡ä»¶ï¼šå¿…é¡»å…è®¸é‡è¯•ï¼Œæ¸¸æˆæœªç»“æŸï¼ŒAI æœªåœ¨æ€è€ƒ
            if (!aiCanRetry || gameOver || aiIsThinking) {
                 console.warn("é‡è¯•æŒ‰é’®è¢«ç‚¹å‡»ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³ã€‚");
                 return;
            }

            logMessage("ç©å®¶è§¦å‘ AI é‡è¯•...", "warning");
            aiCanRetry = false; // æ¶ˆè€—æ‰è¿™æ¬¡é‡è¯•æœºä¼š
            currentPlayer = aiPlayer; // å°†å›åˆè®¾ç½®å› AI
            const currentPieceColor = aiPlayer === 1 ? 'é»‘æ£‹' : 'ç™½æ£‹';
            updateStatus(`AI (${currentPieceColor}) é‡è¯•ä¸­...`); // æ›´æ–°çŠ¶æ€
            aiIsThinking = true; // è®¾ç½®æ€è€ƒæ ‡å¿—
            updateControlStates(); // ç¦ç”¨æ£‹ç›˜ã€ç¦ç”¨é‡è¯•æŒ‰é’®ç­‰
            setTimeout(triggerAIMove, 100); // å¿«é€Ÿè§¦å‘ AI é‡è¯•
        });


        // API é…ç½®ç›‘å¬å™¨
        // API é…ç½®é€‰æ‹©ä¸‹æ‹‰æ¡†å˜åŒ–ç›‘å¬
        apiConfigSelect.addEventListener('change', (e) => {
            selectedConfigName = e.target.value; // æ›´æ–°é€‰ä¸­çš„é…ç½®åç§°
            localStorage.setItem('gomoku_selectedConfigName_v1', selectedConfigName); // ä¿å­˜åˆ° localStorage (ä½¿ç”¨ v1 key)
            displaySelectedConfig(); // æ›´æ–° UI å­—æ®µå’Œæ¨¡å‹åˆ—è¡¨
            updateGameSettingsUI(); // é‡æ–°åŒæ­¥æ¸¸æˆè®¾ç½® UI (ç‰¹åˆ«æ˜¯æ¨¡å‹é€‰æ‹©)
            logMessage(`å·²åˆ‡æ¢åˆ° API é…ç½®: ${selectedConfigName}`, "info");
        });

        // æ·»åŠ æ–° API é…ç½®æŒ‰é’®ç›‘å¬
        addApiConfigBtn.addEventListener('click', () => {
            const newName = apiConfigNameInput.value.trim(); // è·å–æ–°åç§°
            const newUrl = apiUrlInput.value.trim(); // è·å–æ–° URL
            const newKey = apiKeyInput.value.trim(); // è·å–æ–° Key
            const newModelsRaw = apiModelsListInput.value.trim(); // è·å–åŸå§‹æ¨¡å‹åˆ—è¡¨å­—ç¬¦ä¸²
            // åˆ†å‰²ã€å»é™¤ç©ºæ ¼å¹¶è¿‡æ»¤æ‰ç©ºå­—ç¬¦ä¸²ï¼Œå¾—åˆ°æ¨¡å‹æ•°ç»„
            const newModels = newModelsRaw ? newModelsRaw.split(',').map(m => m.trim()).filter(m => m) : [];

            if (!newName || !newUrl /*|| !newKey*/) { // åç§°å’Œ URL æ˜¯å¿…éœ€çš„ï¼ŒKey å¯èƒ½å¯¹æŸäº› API æ˜¯å¯é€‰çš„ï¼Ÿè®©ç”¨æˆ·å†³å®šã€‚
                 alert("é”™è¯¯ï¼šæ–°é…ç½®çš„åç§°å’Œ URL ä¸èƒ½ä¸ºç©ºã€‚");
                 return;
            }
            if (apiConfigs.some(c => c.name === newName)) { // æ£€æŸ¥åç§°æ˜¯å¦å·²å­˜åœ¨
                 alert(`é”™è¯¯ï¼šé…ç½®åç§° "${newName}" å·²å­˜åœ¨ã€‚`);
                 return;
            }

            const newConfig = { name: newName, url: newUrl, key: newKey, models: newModels }; // åˆ›å»ºæ–°é…ç½®å¯¹è±¡
            apiConfigs.push(newConfig); // æ·»åŠ åˆ°é…ç½®æ•°ç»„
            selectedConfigName = newName; // é€‰ä¸­æ–°æ·»åŠ çš„é…ç½®

            saveApiConfigs(); // ä¿å­˜æ‰€æœ‰é…ç½®ï¼ŒåŒ…æ‹¬æ–°çš„
            populateApiConfigSelect(); // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨ (å°†é€‰ä¸­æ–°çš„)
            displaySelectedConfig(); // æ˜¾ç¤ºæ–°é…ç½®çš„è¯¦ç»†ä¿¡æ¯å¹¶æ›´æ–°æ¨¡å‹åˆ—è¡¨
            updateGameSettingsUI(); // åŒæ­¥æ¸¸æˆè®¾ç½® UI
            logMessage(`å·²æ·»åŠ æ–° API é…ç½®: ${newName}`, "success");
        });

        // ä¿å­˜å¯¹é€‰ä¸­ API é…ç½®çš„æ›´æ”¹æŒ‰é’®ç›‘å¬
        saveApiConfigBtn.addEventListener('click', () => {
            const targetName = apiConfigSelect.value; // æ­£åœ¨ç¼–è¾‘çš„é…ç½®åç§° (æ¥è‡ªä¸‹æ‹‰åˆ—è¡¨)
            const editedName = apiConfigNameInput.value.trim(); // è¾“å…¥æ¡†ä¸­çš„æ–°åç§°
            const editedUrl = apiUrlInput.value.trim(); // ç¼–è¾‘åçš„ URL
            const editedKey = apiKeyInput.value.trim(); // ç¼–è¾‘åçš„ Key
            const editedModelsRaw = apiModelsListInput.value.trim(); // ç¼–è¾‘åçš„åŸå§‹æ¨¡å‹åˆ—è¡¨
            const editedModels = editedModelsRaw ? editedModelsRaw.split(',').map(m => m.trim()).filter(m => m) : []; // ç¼–è¾‘åçš„æ¨¡å‹æ•°ç»„

            if (!editedName || !editedUrl /*|| !editedKey*/) { // åç§°å’Œ URL ä¸èƒ½ä¸ºç©º
                 alert("é”™è¯¯ï¼šé…ç½®åç§°å’Œ URL ä¸èƒ½ä¸ºç©ºã€‚");
                 return;
            }

            const configIndex = apiConfigs.findIndex(c => c.name === targetName); // æŸ¥æ‰¾è¦ç¼–è¾‘çš„é…ç½®çš„ç´¢å¼•
            if (configIndex === -1) { // å¦‚æœæ‰¾ä¸åˆ°
                 alert("é”™è¯¯ï¼šæ‰¾ä¸åˆ°è¦ç¼–è¾‘çš„é…ç½®ã€‚è¯·ä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé…ç½®ã€‚");
                 return;
            }
            // æ£€æŸ¥ *æ–°* åç§°æ˜¯å¦ä¸ *å¦ä¸€ä¸ª* ç°æœ‰é…ç½®å†²çª
            if (editedName !== targetName && apiConfigs.some(c => c.name === editedName)) {
                 alert(`é”™è¯¯ï¼šé…ç½®åç§° "${editedName}" å·²è¢«å…¶ä»–é…ç½®ä½¿ç”¨ã€‚`);
                 return;
            }

            // æ›´æ–°æ•°ç»„ä¸­çš„é…ç½®å¯¹è±¡
            apiConfigs[configIndex] = { name: editedName, url: editedUrl, key: editedKey, models: editedModels };
            selectedConfigName = editedName; // æ›´æ–°é€‰ä¸­çš„åç§°ï¼Œä»¥é˜²åç§°è¢«æ›´æ”¹

            saveApiConfigs(); // ä¿å­˜æ›´æ–°åçš„æ•°ç»„
            populateApiConfigSelect(); // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨ (åæ˜ å¯èƒ½çš„åç§°æ›´æ”¹å’Œé€‰æ‹©)
            displaySelectedConfig(); // æ˜¾ç¤ºæ›´æ–°åçš„è¯¦ç»†ä¿¡æ¯å¹¶æ›´æ–°æ¨¡å‹åˆ—è¡¨
            updateGameSettingsUI(); // åŒæ­¥æ¸¸æˆè®¾ç½® UI
            logMessage(`å·²æ›´æ–° API é…ç½®: ${editedName}`, "success");
        });

        // åˆ é™¤é€‰ä¸­ API é…ç½®æŒ‰é’®ç›‘å¬
        deleteApiConfigBtn.addEventListener('click', () => {
            if (apiConfigs.length <= 1) { // å¦‚æœåªå‰©ä¸€ä¸ªé…ç½®
                 alert("é”™è¯¯ï¼šä¸èƒ½åˆ é™¤å”¯ä¸€çš„ API é…ç½®ã€‚è¯·å…ˆæ·»åŠ ä¸€ä¸ªæ–°é…ç½®ã€‚");
                 return;
            }
            const targetName = apiConfigSelect.value; // è·å–è¦åˆ é™¤çš„é…ç½®åç§°
            if (!targetName) { // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•é…ç½®
                 alert("è¯·å…ˆä»ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªè¦åˆ é™¤çš„é…ç½®ã€‚");
                 return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½® "${targetName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) { // ç¡®è®¤åˆ é™¤
                apiConfigs = apiConfigs.filter(c => c.name !== targetName); // ä»æ•°ç»„ä¸­è¿‡æ»¤æ‰è¯¥é…ç½®
                // é€‰æ‹©å‰©ä½™çš„ç¬¬ä¸€ä¸ªé…ç½®
                selectedConfigName = apiConfigs[0]?.name || '';

                saveApiConfigs(); // ä¿å­˜ä¿®æ”¹åçš„æ•°ç»„å’Œæ–°çš„é€‰æ‹©
                populateApiConfigSelect(); // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨
                displaySelectedConfig(); // æ˜¾ç¤ºæ–°é€‰ä¸­çš„é…ç½®
                updateGameSettingsUI(); // åŒæ­¥æ¸¸æˆè®¾ç½® UI
                logMessage(`å·²åˆ é™¤ API é…ç½®: ${targetName}`, "success");
            }
        });

        // é¢æ¿åˆ‡æ¢åŠŸèƒ½
        const setupPanelToggle = (buttonId, contentId) => {
            const button = document.getElementById(buttonId); // è·å–æŒ‰é’®å…ƒç´ 
            const content = document.getElementById(contentId); // è·å–å†…å®¹å…ƒç´ 
            if (!button || !content) { // æ£€æŸ¥å…ƒç´ æ˜¯å¦å­˜åœ¨
                console.warn(`åˆ‡æ¢è®¾ç½®å¤±è´¥: æœªæ‰¾åˆ°æŒ‰é’® '${buttonId}' æˆ–å†…å®¹ '${contentId}'ã€‚`);
                return;
            }
            // æ ¹æ®åˆå§‹æ˜¾ç¤ºæ ·å¼è®¾ç½®æŒ‰é’®æ–‡æœ¬ (å¯é€‰ï¼Œå‡è®¾é»˜è®¤ä¸º block)
            const isInitiallyHidden = content.style.display === 'none';
            button.textContent = isInitiallyHidden ? '(+)' : '(-)';

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            button.addEventListener('click', () => {
                const isHidden = content.style.display === 'none'; // æ£€æŸ¥å½“å‰æ˜¯å¦éšè—
                content.style.display = isHidden ? 'block' : 'none'; // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                button.textContent = isHidden ? '(-)' : '(+)'; // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            });
        };
        // è®¾ç½®å„ä¸ªé¢æ¿çš„åˆ‡æ¢æŒ‰é’®
        setupPanelToggle('toggle-api-config', 'api-config-content');
        setupPanelToggle('toggle-game-settings', 'game-settings-content');
        setupPanelToggle('toggle-log-panel', 'log-panel-content');


        // --- åˆå§‹åŠ è½½ ---
        loadSettings(); // é¡µé¢åŠ è½½æ—¶åŠ è½½ä¿å­˜çš„è®¾ç½®
        initGame();     // åˆå§‹åŒ–æ¸¸æˆæ£‹ç›˜ (é»˜è®¤ç©å®¶å…ˆæ‰‹)

    </script>
</body>
</html>
